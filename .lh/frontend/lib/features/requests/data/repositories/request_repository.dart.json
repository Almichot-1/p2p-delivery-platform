{
    "sourceFile": "frontend/lib/features/requests/data/repositories/request_repository.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1766327062896,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766328719426,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,129 @@\n+import 'dart:io';\r\n+import 'package:cloud_firestore/cloud_firestore.dart';\r\n+import '../../../../core/services/firebase_service.dart';\r\n+import '../../../../core/services/storage_service.dart';\r\n+import '../models/request_model.dart';\r\n \r\n+class RequestRepository {\r\n+  final FirebaseService _firebaseService;\r\n+  final StorageService _storageService;\r\n+\r\n+  RequestRepository(this._firebaseService, this._storageService);\r\n+\r\n+  // Get all active requests\r\n+  Stream<List<RequestModel>> getActiveRequests({\r\n+    String? deliveryCity,\r\n+    ItemCategory? category,\r\n+    int limit = 20,\r\n+  }) {\r\n+    Query query = _firebaseService.requestsCollection\r\n+        .where('status', isEqualTo: RequestStatus.active.name)\r\n+        .orderBy('createdAt', descending: true);\r\n+\r\n+    if (deliveryCity != null) {\r\n+      query = query.where('deliveryCity', isEqualTo: deliveryCity);\r\n+    }\r\n+\r\n+    query = query.limit(limit);\r\n+\r\n+    return query.snapshots().map((snapshot) =>\r\n+        snapshot.docs.map((doc) => RequestModel.fromFirestore(doc)).toList());\r\n+  }\r\n+\r\n+  // Get requests by requester\r\n+  Stream<List<RequestModel>> getRequestsByRequester(String requesterId) {\r\n+    return _firebaseService.requestsCollection\r\n+        .where('requesterId', isEqualTo: requesterId)\r\n+        .orderBy('createdAt', descending: true)\r\n+        .snapshots()\r\n+        .map((snapshot) =>\r\n+            snapshot.docs.map((doc) => RequestModel.fromFirestore(doc)).toList());\r\n+  }\r\n+\r\n+  // Get single request\r\n+  Stream<RequestModel?> getRequestById(String requestId) {\r\n+    return _firebaseService.requestsCollection\r\n+        .doc(requestId)\r\n+        .snapshots()\r\n+        .map((doc) => doc.exists ? RequestModel.fromFirestore(doc) : null);\r\n+  }\r\n+\r\n+  // Create request with images\r\n+  Future<String> createRequest(\r\n+    RequestModel request, {\r\n+    List<File>? images,\r\n+  }) async {\r\n+    // Upload images first\r\n+    List<String> imageUrls = [];\r\n+    if (images != null && images.isNotEmpty) {\r\n+      final tempDocRef = _firebaseService.requestsCollection.doc();\r\n+      imageUrls = await _storageService.uploadMultipleImages(\r\n+        images,\r\n+        tempDocRef.id,\r\n+      );\r\n+    }\r\n+\r\n+    // Create request with image URLs\r\n+    final requestWithImages = request.copyWith(imageUrls: imageUrls);\r\n+    final docRef = await _firebaseService.requestsCollection\r\n+        .add(requestWithImages.toFirestore());\r\n+\r\n+    return docRef.id;\r\n+  }\r\n+\r\n+  // Update request\r\n+  Future<void> updateRequest(RequestModel request) async {\r\n+    await _firebaseService.requestsCollection\r\n+        .doc(request.id)\r\n+        .update(request.toFirestore());\r\n+  }\r\n+\r\n+  // Cancel request\r\n+  Future<void> cancelRequest(String requestId) async {\r\n+    await _firebaseService.requestsCollection.doc(requestId).update({\r\n+      'status': RequestStatus.cancelled.name,\r\n+      'updatedAt': FieldValue.serverTimestamp(),\r\n+    });\r\n+  }\r\n+\r\n+  // Search requests\r\n+  Future<List<RequestModel>> searchRequests({\r\n+    required String deliveryCity,\r\n+    double? maxWeight,\r\n+    ItemCategory? category,\r\n+  }) async {\r\n+    Query query = _firebaseService.requestsCollection\r\n+        .where('status', isEqualTo: RequestStatus.active.name)\r\n+        .where('deliveryCity', isEqualTo: deliveryCity);\r\n+\r\n+    final snapshot = await query.get();\r\n+    var requests =\r\n+        snapshot.docs.map((doc) => RequestModel.fromFirestore(doc)).toList();\r\n+\r\n+    // Client-side filtering for complex queries\r\n+    if (maxWeight != null) {\r\n+      requests = requests.where((r) => r.weightKg <= maxWeight).toList();\r\n+    }\r\n+\r\n+    if (category != null) {\r\n+      requests = requests.where((r) => r.category == category).toList();\r\n+    }\r\n+\r\n+    return requests;\r\n+  }\r\n+\r\n+  // Delete request\r\n+  Future<void> deleteRequest(String requestId) async {\r\n+    // Get request to delete images\r\n+    final doc =\r\n+        await _firebaseService.requestsCollection.doc(requestId).get();\r\n+    if (doc.exists) {\r\n+      final request = RequestModel.fromFirestore(doc);\r\n+      // Delete associated images\r\n+      for (final url in request.imageUrls) {\r\n+        await _storageService.deleteFile(url);\r\n+      }\r\n+    }\r\n+    await _firebaseService.requestsCollection.doc(requestId).delete();\r\n+  }\r\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1766327062896,
            "name": "Commit-0",
            "content": "\r\n"
        }
    ]
}