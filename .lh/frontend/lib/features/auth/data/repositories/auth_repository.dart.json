{
    "sourceFile": "frontend/lib/features/auth/data/repositories/auth_repository.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1766327036503,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766327638101,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,238 @@\n+import 'package:firebase_auth/firebase_auth.dart';\r\n+import 'package:cloud_firestore/cloud_firestore.dart';\r\n+import '../../../../core/services/firebase_service.dart';\r\n+import '../models/user_model.dart';\r\n \r\n+class AuthRepository {\r\n+  final FirebaseService _firebaseService;\r\n+\r\n+  AuthRepository(this._firebaseService);\r\n+\r\n+  // Auth state stream\r\n+  Stream<User?> get authStateChanges => _firebaseService.authStateChanges;\r\n+\r\n+  // Current user\r\n+  User? get currentUser => _firebaseService.currentUser;\r\n+  String? get currentUserId => _firebaseService.currentUserId;\r\n+\r\n+  // Register with email and password\r\n+  Future<UserModel> registerWithEmail({\r\n+    required String email,\r\n+    required String password,\r\n+    required String fullName,\r\n+    String? phone,\r\n+  }) async {\r\n+    try {\r\n+      // Create auth user\r\n+      final credential = await _firebaseService.auth.createUserWithEmailAndPassword(\r\n+        email: email,\r\n+        password: password,\r\n+      );\r\n+\r\n+      final user = credential.user;\r\n+      if (user == null) {\r\n+        throw Exception('Registration failed');\r\n+      }\r\n+\r\n+      // Update display name\r\n+      await user.updateDisplayName(fullName);\r\n+\r\n+      // Create user document\r\n+      final userModel = UserModel(\r\n+        uid: user.uid,\r\n+        email: email,\r\n+        fullName: fullName,\r\n+        phone: phone,\r\n+        createdAt: DateTime.now(),\r\n+        updatedAt: DateTime.now(),\r\n+      );\r\n+\r\n+      await _firebaseService.usersCollection\r\n+          .doc(user.uid)\r\n+          .set(userModel.toFirestore());\r\n+\r\n+      return userModel;\r\n+    } on FirebaseAuthException catch (e) {\r\n+      throw _handleAuthException(e);\r\n+    }\r\n+  }\r\n+\r\n+  // Login with email and password\r\n+  Future<UserModel> loginWithEmail({\r\n+    required String email,\r\n+    required String password,\r\n+  }) async {\r\n+    try {\r\n+      final credential = await _firebaseService.auth.signInWithEmailAndPassword(\r\n+        email: email,\r\n+        password: password,\r\n+      );\r\n+\r\n+      final user = credential.user;\r\n+      if (user == null) {\r\n+        throw Exception('Login failed');\r\n+      }\r\n+\r\n+      // Update online status\r\n+      await _updateOnlineStatus(true);\r\n+\r\n+      // Get user data\r\n+      return await getUserData(user.uid);\r\n+    } on FirebaseAuthException catch (e) {\r\n+      throw _handleAuthException(e);\r\n+    }\r\n+  }\r\n+\r\n+  // Phone authentication - Send OTP\r\n+  Future<void> sendPhoneOTP({\r\n+    required String phoneNumber,\r\n+    required void Function(String verificationId) onCodeSent,\r\n+    required void Function(String error) onError,\r\n+    required void Function(PhoneAuthCredential credential) onAutoVerify,\r\n+  }) async {\r\n+    await _firebaseService.auth.verifyPhoneNumber(\r\n+      phoneNumber: phoneNumber,\r\n+      timeout: const Duration(seconds: 60),\r\n+      verificationCompleted: onAutoVerify,\r\n+      verificationFailed: (e) => onError(e.message ?? 'Verification failed'),\r\n+      codeSent: (verificationId, _) => onCodeSent(verificationId),\r\n+      codeAutoRetrievalTimeout: (_) {},\r\n+    );\r\n+  }\r\n+\r\n+  // Phone authentication - Verify OTP\r\n+  Future<UserModel> verifyPhoneOTP({\r\n+    required String verificationId,\r\n+    required String otp,\r\n+    required String fullName,\r\n+  }) async {\r\n+    try {\r\n+      final credential = PhoneAuthProvider.credential(\r\n+        verificationId: verificationId,\r\n+        smsCode: otp,\r\n+      );\r\n+\r\n+      final userCredential = await _firebaseService.auth.signInWithCredential(credential);\r\n+      final user = userCredential.user;\r\n+\r\n+      if (user == null) {\r\n+        throw Exception('Phone verification failed');\r\n+      }\r\n+\r\n+      // Check if user exists\r\n+      final doc = await _firebaseService.usersCollection.doc(user.uid).get();\r\n+\r\n+      if (doc.exists) {\r\n+        await _updateOnlineStatus(true);\r\n+        return UserModel.fromFirestore(doc);\r\n+      }\r\n+\r\n+      // Create new user\r\n+      final userModel = UserModel(\r\n+        uid: user.uid,\r\n+        email: '',\r\n+        fullName: fullName,\r\n+        phone: user.phoneNumber,\r\n+        createdAt: DateTime.now(),\r\n+        updatedAt: DateTime.now(),\r\n+      );\r\n+\r\n+      await _firebaseService.usersCollection\r\n+          .doc(user.uid)\r\n+          .set(userModel.toFirestore());\r\n+\r\n+      return userModel;\r\n+    } on FirebaseAuthException catch (e) {\r\n+      throw _handleAuthException(e);\r\n+    }\r\n+  }\r\n+\r\n+  // Forgot password\r\n+  Future<void> sendPasswordResetEmail(String email) async {\r\n+    try {\r\n+      await _firebaseService.auth.sendPasswordResetEmail(email: email);\r\n+    } on FirebaseAuthException catch (e) {\r\n+      throw _handleAuthException(e);\r\n+    }\r\n+  }\r\n+\r\n+  // Get user data\r\n+  Future<UserModel> getUserData(String uid) async {\r\n+    final doc = await _firebaseService.usersCollection.doc(uid).get();\r\n+    if (!doc.exists) {\r\n+      throw Exception('User not found');\r\n+    }\r\n+    return UserModel.fromFirestore(doc);\r\n+  }\r\n+\r\n+  // Get current user data\r\n+  Future<UserModel?> getCurrentUserData() async {\r\n+    final uid = currentUserId;\r\n+    if (uid == null) return null;\r\n+    return await getUserData(uid);\r\n+  }\r\n+\r\n+  // Stream current user data\r\n+  Stream<UserModel?> streamCurrentUser() {\r\n+    final uid = currentUserId;\r\n+    if (uid == null) return Stream.value(null);\r\n+\r\n+    return _firebaseService.usersCollection\r\n+        .doc(uid)\r\n+        .snapshots()\r\n+        .map((doc) => doc.exists ? UserModel.fromFirestore(doc) : null);\r\n+  }\r\n+\r\n+  // Update online status\r\n+  Future<void> _updateOnlineStatus(bool isOnline) async {\r\n+    final uid = currentUserId;\r\n+    if (uid == null) return;\r\n+\r\n+    await _firebaseService.usersCollection.doc(uid).update({\r\n+      'isOnline': isOnline,\r\n+      'lastSeen': FieldValue.serverTimestamp(),\r\n+    });\r\n+  }\r\n+\r\n+  // Logout\r\n+  Future<void> logout() async {\r\n+    await _updateOnlineStatus(false);\r\n+    await _firebaseService.auth.signOut();\r\n+  }\r\n+\r\n+  // Delete account\r\n+  Future<void> deleteAccount() async {\r\n+    final user = currentUser;\r\n+    if (user == null) return;\r\n+\r\n+    // Delete user document\r\n+    await _firebaseService.usersCollection.doc(user.uid).delete();\r\n+\r\n+    // Delete auth user\r\n+    await user.delete();\r\n+  }\r\n+\r\n+  // Handle auth exceptions\r\n+  String _handleAuthException(FirebaseAuthException e) {\r\n+    switch (e.code) {\r\n+      case 'email-already-in-use':\r\n+        return 'This email is already registered';\r\n+      case 'invalid-email':\r\n+        return 'Invalid email address';\r\n+      case 'weak-password':\r\n+        return 'Password is too weak';\r\n+      case 'user-not-found':\r\n+        return 'No user found with this email';\r\n+      case 'wrong-password':\r\n+        return 'Incorrect password';\r\n+      case 'user-disabled':\r\n+        return 'This account has been disabled';\r\n+      case 'too-many-requests':\r\n+        return 'Too many attempts. Please try again later';\r\n+      case 'invalid-verification-code':\r\n+        return 'Invalid verification code';\r\n+      default:\r\n+        return e.message ?? 'Authentication failed';\r\n+    }\r\n+  }\r\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1766327036503,
            "name": "Commit-0",
            "content": "\r\n"
        }
    ]
}