{
    "sourceFile": "frontend/lib/features/chat/data/repositories/chat_repository.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1766327121756,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766329025303,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,116 @@\n+import 'dart:io';\r\n+import 'package:cloud_firestore/cloud_firestore.dart';\r\n+import '../../../../core/services/firebase_service.dart';\r\n+import '../../../../core/services/storage_service.dart';\r\n+import '../models/message_model.dart';\r\n \r\n+class ChatRepository {\r\n+  final FirebaseService _firebaseService;\r\n+  final StorageService _storageService;\r\n+\r\n+  ChatRepository(this._firebaseService, this._storageService);\r\n+\r\n+  // Get messages for a match\r\n+  Stream<List<MessageModel>> getMessages(String matchId) {\r\n+    return _firebaseService.matchesCollection\r\n+        .doc(matchId)\r\n+        .collection('messages')\r\n+        .orderBy('createdAt', descending: false)\r\n+        .snapshots()\r\n+        .map((snapshot) =>\r\n+            snapshot.docs.map((doc) => MessageModel.fromFirestore(doc)).toList());\r\n+  }\r\n+\r\n+  // Send text message\r\n+  Future<void> sendMessage({\r\n+    required String matchId,\r\n+    required String senderId,\r\n+    required String senderName,\r\n+    required String content,\r\n+  }) async {\r\n+    final message = MessageModel(\r\n+      id: '',\r\n+      matchId: matchId,\r\n+      senderId: senderId,\r\n+      senderName: senderName,\r\n+      content: content,\r\n+      type: MessageType.text,\r\n+      createdAt: DateTime.now(),\r\n+    );\r\n+\r\n+    await _firebaseService.matchesCollection\r\n+        .doc(matchId)\r\n+        .collection('messages')\r\n+        .add(message.toFirestore());\r\n+\r\n+    // Update last message in match\r\n+    await _firebaseService.matchesCollection.doc(matchId).update({\r\n+      'lastMessage': content,\r\n+      'lastMessageAt': FieldValue.serverTimestamp(),\r\n+      'lastMessageSenderId': senderId,\r\n+    });\r\n+  }\r\n+\r\n+  // Send image message\r\n+  Future<void> sendImageMessage({\r\n+    required String matchId,\r\n+    required String senderId,\r\n+    required String senderName,\r\n+    required File imageFile,\r\n+  }) async {\r\n+    // Upload image\r\n+    final imageUrl = await _storageService.uploadChatImage(imageFile, matchId);\r\n+\r\n+    final message = MessageModel(\r\n+      id: '',\r\n+      matchId: matchId,\r\n+      senderId: senderId,\r\n+      senderName: senderName,\r\n+      content: 'ðŸ“· Image',\r\n+      type: MessageType.image,\r\n+      imageUrl: imageUrl,\r\n+      createdAt: DateTime.now(),\r\n+    );\r\n+\r\n+    await _firebaseService.matchesCollection\r\n+        .doc(matchId)\r\n+        .collection('messages')\r\n+        .add(message.toFirestore());\r\n+\r\n+    // Update last message\r\n+    await _firebaseService.matchesCollection.doc(matchId).update({\r\n+      'lastMessage': 'ðŸ“· Image',\r\n+      'lastMessageAt': FieldValue.serverTimestamp(),\r\n+      'lastMessageSenderId': senderId,\r\n+    });\r\n+  }\r\n+\r\n+  // Mark messages as read\r\n+  Future<void> markMessagesAsRead(String matchId, String currentUserId) async {\r\n+    final batch = _firebaseService.firestore.batch();\r\n+    \r\n+    final unreadMessages = await _firebaseService.matchesCollection\r\n+        .doc(matchId)\r\n+        .collection('messages')\r\n+        .where('isRead', isEqualTo: false)\r\n+        .where('senderId', isNotEqualTo: currentUserId)\r\n+        .get();\r\n+\r\n+    for (final doc in unreadMessages.docs) {\r\n+      batch.update(doc.reference, {'isRead': true});\r\n+    }\r\n+\r\n+    await batch.commit();\r\n+  }\r\n+\r\n+  // Get unread count\r\n+  Stream<int> getUnreadCount(String matchId, String currentUserId) {\r\n+    return _firebaseService.matchesCollection\r\n+        .doc(matchId)\r\n+        .collection('messages')\r\n+        .where('isRead', isEqualTo: false)\r\n+        .where('senderId', isNotEqualTo: currentUserId)\r\n+        .snapshots()\r\n+        .map((snapshot) => snapshot.docs.length);\r\n+  }\r\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1766327121756,
            "name": "Commit-0",
            "content": "\r\n"
        }
    ]
}