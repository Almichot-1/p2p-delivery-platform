{
    "sourceFile": "frontend/lib/features/chat/presentation/screens/chat_screen.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1766327121759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766329178248,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,329 @@\n+import 'dart:io';\r\n+import 'package:flutter/material.dart';\r\n+import 'package:flutter_bloc/flutter_bloc.dart';\r\n+import 'package:image_picker/image_picker.dart';\r\n \r\n+import '../../../../config/dependency_injection.dart';\r\n+import '../../../../core/theme/app_colors.dart';\r\n+import '../../../../core/theme/app_text_styles.dart';\r\n+import '../../../../core/widgets/loading_widget.dart';\r\n+import '../../../../core/widgets/user_avatar.dart';\r\n+import '../../../auth/bloc/auth_bloc.dart';\r\n+import '../../../auth/bloc/auth_state.dart';\r\n+import '../../../matches/bloc/match_bloc.dart';\r\n+import '../../../matches/bloc/match_event.dart';\r\n+import '../../../matches/bloc/match_state.dart';\r\n+import '../../bloc/chat_bloc.dart';\r\n+import '../../bloc/chat_event.dart';\r\n+import '../../bloc/chat_state.dart';\r\n+import '../widgets/message_bubble.dart';\r\n+import '../widgets/chat_input.dart';\r\n+\r\n+class ChatScreen extends StatefulWidget {\r\n+  final String matchId;\r\n+\r\n+  const ChatScreen({super.key, required this.matchId});\r\n+\r\n+  @override\r\n+  State<ChatScreen> createState() => _ChatScreenState();\r\n+}\r\n+\r\n+class _ChatScreenState extends State<ChatScreen> {\r\n+  final _scrollController = ScrollController();\r\n+  final _imagePicker = ImagePicker();\r\n+\r\n+  @override\r\n+  void initState() {\r\n+    super.initState();\r\n+    // Mark messages as read when entering chat\r\n+    context.read<ChatBloc>().add(ChatMarkAsReadRequested(widget.matchId));\r\n+  }\r\n+\r\n+  @override\r\n+  void dispose() {\r\n+    _scrollController.dispose();\r\n+    super.dispose();\r\n+  }\r\n+\r\n+  void _scrollToBottom() {\r\n+    if (_scrollController.hasClients) {\r\n+      _scrollController.animateTo(\r\n+        _scrollController.position.maxScrollExtent,\r\n+        duration: const Duration(milliseconds: 300),\r\n+        curve: Curves.easeOut,\r\n+      );\r\n+    }\r\n+  }\r\n+\r\n+  void _sendMessage(String content) {\r\n+    if (content.trim().isEmpty) return;\r\n+\r\n+    context.read<ChatBloc>().add(\r\n+          ChatSendMessageRequested(\r\n+            matchId: widget.matchId,\r\n+            content: content.trim(),\r\n+          ),\r\n+        );\r\n+\r\n+    Future.delayed(const Duration(milliseconds: 100), _scrollToBottom);\r\n+  }\r\n+\r\n+  Future<void> _pickAndSendImage() async {\r\n+    final pickedFile = await _imagePicker.pickImage(\r\n+      source: ImageSource.gallery,\r\n+      maxWidth: 1024,\r\n+      maxHeight: 1024,\r\n+      imageQuality: 80,\r\n+    );\r\n+\r\n+    if (pickedFile != null) {\r\n+      context.read<ChatBloc>().add(\r\n+            ChatSendImageRequested(\r\n+              matchId: widget.matchId,\r\n+              imageFile: File(pickedFile.path),\r\n+            ),\r\n+          );\r\n+    }\r\n+  }\r\n+\r\n+  @override\r\n+  Widget build(BuildContext context) {\r\n+    final authState = context.read<AuthBloc>().state;\r\n+    final currentUserId =\r\n+        authState is AuthAuthenticated ? authState.user.uid : '';\r\n+\r\n+    return MultiBlocProvider(\r\n+      providers: [\r\n+        BlocProvider(\r\n+          create: (_) => getIt<ChatBloc>()\r\n+            ..add(ChatMessagesRequested(widget.matchId)),\r\n+        ),\r\n+        BlocProvider(\r\n+          create: (_) => getIt<MatchBloc>()\r\n+            ..add(MatchDetailsRequested(widget.matchId)),\r\n+        ),\r\n+      ],\r\n+      child: Scaffold(\r\n+        appBar: _buildAppBar(),\r\n+        body: Column(\r\n+          children: [\r\n+            // Messages list\r\n+            Expanded(\r\n+              child: BlocConsumer<ChatBloc, ChatState>(\r\n+                listener: (context, state) {\r\n+                  if (state is ChatMessagesLoaded) {\r\n+                    Future.delayed(\r\n+                      const Duration(milliseconds: 100),\r\n+                      _scrollToBottom,\r\n+                    );\r\n+                  }\r\n+                },\r\n+                builder: (context, state) {\r\n+                  if (state is ChatLoading) {\r\n+                    return const LoadingWidget();\r\n+                  }\r\n+\r\n+                  if (state is ChatError) {\r\n+                    return Center(child: Text(state.message));\r\n+                  }\r\n+\r\n+                  if (state is ChatMessagesLoaded) {\r\n+                    if (state.messages.isEmpty) {\r\n+                      return _buildEmptyChat();\r\n+                    }\r\n+\r\n+                    return ListView.builder(\r\n+                      controller: _scrollController,\r\n+                      padding: const EdgeInsets.all(16),\r\n+                      itemCount: state.messages.length,\r\n+                      itemBuilder: (context, index) {\r\n+                        final message = state.messages[index];\r\n+                        final isMine = message.senderId == currentUserId;\r\n+\r\n+                        // Check if we should show date separator\r\n+                        bool showDate = false;\r\n+                        if (index == 0) {\r\n+                          showDate = true;\r\n+                        } else {\r\n+                          final prevMessage = state.messages[index - 1];\r\n+                          showDate = !_isSameDay(\r\n+                            message.createdAt,\r\n+                            prevMessage.createdAt,\r\n+                          );\r\n+                        }\r\n+\r\n+                        return Column(\r\n+                          children: [\r\n+                            if (showDate) _buildDateSeparator(message.createdAt),\r\n+                            MessageBubble(\r\n+                              message: message,\r\n+                              isMine: isMine,\r\n+                            ),\r\n+                          ],\r\n+                        );\r\n+                      },\r\n+                    );\r\n+                  }\r\n+\r\n+                  return const SizedBox.shrink();\r\n+                },\r\n+              ),\r\n+            ),\r\n+\r\n+            // Image sending indicator\r\n+            BlocBuilder<ChatBloc, ChatState>(\r\n+              builder: (context, state) {\r\n+                if (state is ChatImageSending) {\r\n+                  return Container(\r\n+                    padding: const EdgeInsets.all(8),\r\n+                    color: AppColors.grey100,\r\n+                    child: const Row(\r\n+                      mainAxisAlignment: MainAxisAlignment.center,\r\n+                      children: [\r\n+                        SizedBox(\r\n+                          width: 16,\r\n+                          height: 16,\r\n+                          child: CircularProgressIndicator(strokeWidth: 2),\r\n+                        ),\r\n+                        SizedBox(width: 8),\r\n+                        Text('Sending image...'),\r\n+                      ],\r\n+                    ),\r\n+                  );\r\n+                }\r\n+                return const SizedBox.shrink();\r\n+              },\r\n+            ),\r\n+\r\n+            // Input field\r\n+            ChatInput(\r\n+              onSend: _sendMessage,\r\n+              onImagePick: _pickAndSendImage,\r\n+            ),\r\n+          ],\r\n+        ),\r\n+      ),\r\n+    );\r\n+  }\r\n+\r\n+  PreferredSizeWidget _buildAppBar() {\r\n+    return AppBar(\r\n+      titleSpacing: 0,\r\n+      title: BlocBuilder<MatchBloc, MatchState>(\r\n+        builder: (context, state) {\r\n+          if (state is MatchDetailsLoaded) {\r\n+            final match = state.match;\r\n+            final authState = context.read<AuthBloc>().state;\r\n+            final currentUserId =\r\n+                authState is AuthAuthenticated ? authState.user.uid : '';\r\n+\r\n+            final otherName = match.getOtherParticipantName(currentUserId);\r\n+            final otherPhoto = match.getOtherParticipantPhoto(currentUserId);\r\n+\r\n+            return Row(\r\n+              children: [\r\n+                UserAvatar(\r\n+                  imageUrl: otherPhoto,\r\n+                  name: otherName,\r\n+                  size: 40,\r\n+                ),\r\n+                const SizedBox(width: 12),\r\n+                Expanded(\r\n+                  child: Column(\r\n+                    crossAxisAlignment: CrossAxisAlignment.start,\r\n+                    children: [\r\n+                      Text(\r\n+                        otherName,\r\n+                        style: AppTextStyles.bodyLarge.copyWith(\r\n+                          fontWeight: FontWeight.w600,\r\n+                        ),\r\n+                      ),\r\n+                      Text(\r\n+                        match.itemTitle,\r\n+                        style: AppTextStyles.caption,\r\n+                        maxLines: 1,\r\n+                        overflow: TextOverflow.ellipsis,\r\n+                      ),\r\n+                    ],\r\n+                  ),\r\n+                ),\r\n+              ],\r\n+            );\r\n+          }\r\n+          return const Text('Chat');\r\n+        },\r\n+      ),\r\n+      actions: [\r\n+        IconButton(\r\n+          icon: const Icon(Icons.info_outline),\r\n+          onPressed: () {\r\n+            // Show match details\r\n+          },\r\n+        ),\r\n+      ],\r\n+    );\r\n+  }\r\n+\r\n+  Widget _buildEmptyChat() {\r\n+    return Center(\r\n+      child: Column(\r\n+        mainAxisAlignment: MainAxisAlignment.center,\r\n+        children: [\r\n+          Icon(\r\n+            Icons.chat_bubble_outline,\r\n+            size: 80,\r\n+            color: AppColors.grey300,\r\n+          ),\r\n+          const SizedBox(height: 16),\r\n+          Text(\r\n+            'No messages yet',\r\n+            style: AppTextStyles.h5.copyWith(color: AppColors.grey500),\r\n+          ),\r\n+          const SizedBox(height: 8),\r\n+          Text(\r\n+            'Start the conversation!',\r\n+            style: AppTextStyles.bodyMedium.copyWith(color: AppColors.grey400),\r\n+          ),\r\n+        ],\r\n+      ),\r\n+    );\r\n+  }\r\n+\r\n+  Widget _buildDateSeparator(DateTime date) {\r\n+    String dateText;\r\n+    final now = DateTime.now();\r\n+    final today = DateTime(now.year, now.month, now.day);\r\n+    final messageDate = DateTime(date.year, date.month, date.day);\r\n+\r\n+    if (messageDate == today) {\r\n+      dateText = 'Today';\r\n+    } else if (messageDate == today.subtract(const Duration(days: 1))) {\r\n+      dateText = 'Yesterday';\r\n+    } else {\r\n+      dateText = '${date.day}/${date.month}/${date.year}';\r\n+    }\r\n+\r\n+    return Padding(\r\n+      padding: const EdgeInsets.symmetric(vertical: 16),\r\n+      child: Center(\r\n+        child: Container(\r\n+          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),\r\n+          decoration: BoxDecoration(\r\n+            color: AppColors.grey200,\r\n+            borderRadius: BorderRadius.circular(12),\r\n+          ),\r\n+          child: Text(\r\n+            dateText,\r\n+            style: AppTextStyles.caption,\r\n+          ),\r\n+        ),\r\n+      ),\r\n+    );\r\n+  }\r\n+\r\n+  bool _isSameDay(DateTime date1, DateTime date2) {\r\n+    return date1.year == date2.year &&\r\n+        date1.month == date2.month &&\r\n+        date1.day == date2.day;\r\n+  }\r\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766346631478,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,332 @@\n+import 'dart:io';\r\n+import 'package:flutter/material.dart';\r\n+import 'package:flutter_bloc/flutter_bloc.dart';\r\n+import 'package:image_picker/image_picker.dart';\r\n+\r\n+import '../../../../config/dependency_injection.dart';\r\n+import '../../../../core/theme/app_colors.dart';\r\n+import '../../../../core/theme/app_text_styles.dart';\r\n+import '../../../../core/widgets/loading_widget.dart';\r\n+import '../../../../core/widgets/user_avatar.dart';\r\n+import '../../../auth/bloc/auth_bloc.dart';\r\n+import '../../../auth/bloc/auth_state.dart';\r\n+import '../../../matches/bloc/match_bloc.dart';\r\n+import '../../../matches/bloc/match_event.dart';\r\n+import '../../../matches/bloc/match_state.dart';\r\n+import '../../bloc/chat_bloc.dart';\r\n+import '../../bloc/chat_event.dart';\r\n+import '../../bloc/chat_state.dart';\r\n+import '../widgets/message_bubble.dart';\r\n+import '../widgets/chat_input.dart';\r\n+\r\n+class ChatScreen extends StatefulWidget {\r\n+  final String matchId;\r\n+\r\n+  const ChatScreen({super.key, required this.matchId});\r\n+\r\n+  @override\r\n+  State<ChatScreen> createState() => _ChatScreenState();\r\n+}\r\n+\r\n+class _ChatScreenState extends State<ChatScreen> {\r\n+  final _scrollController = ScrollController();\r\n+  final _imagePicker = ImagePicker();\r\n+\r\n+  @override\r\n+  void initState() {\r\n+    super.initState();\r\n+    // Mark messages as read when entering chat\r\n+    context.read<ChatBloc>().add(ChatMarkAsReadRequested(widget.matchId));\r\n+  }\r\n+\r\n+  @override\r\n+  void dispose() {\r\n+    _scrollController.dispose();\r\n+    super.dispose();\r\n+  }\r\n+\r\n+  void _scrollToBottom() {\r\n+    if (_scrollController.hasClients) {\r\n+      _scrollController.animateTo(\r\n+        _scrollController.position.maxScrollExtent,\r\n+        duration: const Duration(milliseconds: 300),\r\n+        curve: Curves.easeOut,\r\n+      );\r\n+    }\r\n+  }\r\n+\r\n+  void _sendMessage(String content) {\r\n+    if (content.trim().isEmpty) return;\r\n+\r\n+    context.read<ChatBloc>().add(\r\n+          ChatSendMessageRequested(\r\n+            matchId: widget.matchId,\r\n+            content: content.trim(),\r\n+          ),\r\n+        );\r\n+\r\n+    Future.delayed(const Duration(milliseconds: 100), _scrollToBottom);\r\n+  }\r\n+\r\n+  Future<void> _pickAndSendImage() async {\r\n+    final pickedFile = await _imagePicker.pickImage(\r\n+      source: ImageSource.gallery,\r\n+      maxWidth: 1024,\r\n+      maxHeight: 1024,\r\n+      imageQuality: 80,\r\n+    );\r\n+\r\n+    if (!mounted) return;\r\n+\r\n+    if (pickedFile != null) {\r\n+      context.read<ChatBloc>().add(\r\n+            ChatSendImageRequested(\r\n+              matchId: widget.matchId,\r\n+              imageFile: File(pickedFile.path),\r\n+            ),\r\n+          );\r\n+    }\r\n+  }\r\n+\r\n+  @override\r\n+  Widget build(BuildContext context) {\r\n+    final authState = context.read<AuthBloc>().state;\r\n+    final currentUserId =\r\n+        authState is AuthAuthenticated ? authState.user.uid : '';\r\n+\r\n+    return MultiBlocProvider(\r\n+      providers: [\r\n+        BlocProvider(\r\n+          create: (_) =>\r\n+              getIt<ChatBloc>()..add(ChatMessagesRequested(widget.matchId)),\r\n+        ),\r\n+        BlocProvider(\r\n+          create: (_) =>\r\n+              getIt<MatchBloc>()..add(MatchDetailsRequested(widget.matchId)),\r\n+        ),\r\n+      ],\r\n+      child: Scaffold(\r\n+        appBar: _buildAppBar(),\r\n+        body: Column(\r\n+          children: [\r\n+            // Messages list\r\n+            Expanded(\r\n+              child: BlocConsumer<ChatBloc, ChatState>(\r\n+                listener: (context, state) {\r\n+                  if (state is ChatMessagesLoaded) {\r\n+                    Future.delayed(\r\n+                      const Duration(milliseconds: 100),\r\n+                      _scrollToBottom,\r\n+                    );\r\n+                  }\r\n+                },\r\n+                builder: (context, state) {\r\n+                  if (state is ChatLoading) {\r\n+                    return const LoadingWidget();\r\n+                  }\r\n+\r\n+                  if (state is ChatError) {\r\n+                    return Center(child: Text(state.message));\r\n+                  }\r\n+\r\n+                  if (state is ChatMessagesLoaded) {\r\n+                    if (state.messages.isEmpty) {\r\n+                      return _buildEmptyChat();\r\n+                    }\r\n+\r\n+                    return ListView.builder(\r\n+                      controller: _scrollController,\r\n+                      padding: const EdgeInsets.all(16),\r\n+                      itemCount: state.messages.length,\r\n+                      itemBuilder: (context, index) {\r\n+                        final message = state.messages[index];\r\n+                        final isMine = message.senderId == currentUserId;\r\n+\r\n+                        // Check if we should show date separator\r\n+                        bool showDate = false;\r\n+                        if (index == 0) {\r\n+                          showDate = true;\r\n+                        } else {\r\n+                          final prevMessage = state.messages[index - 1];\r\n+                          showDate = !_isSameDay(\r\n+                            message.createdAt,\r\n+                            prevMessage.createdAt,\r\n+                          );\r\n+                        }\r\n+\r\n+                        return Column(\r\n+                          children: [\r\n+                            if (showDate)\r\n+                              _buildDateSeparator(message.createdAt),\r\n+                            MessageBubble(\r\n+                              message: message,\r\n+                              isMine: isMine,\r\n+                            ),\r\n+                          ],\r\n+                        );\r\n+                      },\r\n+                    );\r\n+                  }\r\n+\r\n+                  return const SizedBox.shrink();\r\n+                },\r\n+              ),\r\n+            ),\r\n+\r\n+            // Image sending indicator\r\n+            BlocBuilder<ChatBloc, ChatState>(\r\n+              builder: (context, state) {\r\n+                if (state is ChatImageSending) {\r\n+                  return Container(\r\n+                    padding: const EdgeInsets.all(8),\r\n+                    color: AppColors.grey100,\r\n+                    child: const Row(\r\n+                      mainAxisAlignment: MainAxisAlignment.center,\r\n+                      children: [\r\n+                        SizedBox(\r\n+                          width: 16,\r\n+                          height: 16,\r\n+                          child: CircularProgressIndicator(strokeWidth: 2),\r\n+                        ),\r\n+                        SizedBox(width: 8),\r\n+                        Text('Sending image...'),\r\n+                      ],\r\n+                    ),\r\n+                  );\r\n+                }\r\n+                return const SizedBox.shrink();\r\n+              },\r\n+            ),\r\n+\r\n+            // Input field\r\n+            ChatInput(\r\n+              onSend: _sendMessage,\r\n+              onImagePick: _pickAndSendImage,\r\n+            ),\r\n+          ],\r\n+        ),\r\n+      ),\r\n+    );\r\n+  }\r\n+\r\n+  PreferredSizeWidget _buildAppBar() {\r\n+    return AppBar(\r\n+      titleSpacing: 0,\r\n+      title: BlocBuilder<MatchBloc, MatchState>(\r\n+        builder: (context, state) {\r\n+          if (state is MatchDetailsLoaded) {\r\n+            final match = state.match;\r\n+            final authState = context.read<AuthBloc>().state;\r\n+            final currentUserId =\r\n+                authState is AuthAuthenticated ? authState.user.uid : '';\r\n+\r\n+            final otherName = match.getOtherParticipantName(currentUserId);\r\n+            final otherPhoto = match.getOtherParticipantPhoto(currentUserId);\r\n+\r\n+            return Row(\r\n+              children: [\r\n+                UserAvatar(\r\n+                  imageUrl: otherPhoto,\r\n+                  name: otherName,\r\n+                  size: 40,\r\n+                ),\r\n+                const SizedBox(width: 12),\r\n+                Expanded(\r\n+                  child: Column(\r\n+                    crossAxisAlignment: CrossAxisAlignment.start,\r\n+                    children: [\r\n+                      Text(\r\n+                        otherName,\r\n+                        style: AppTextStyles.bodyLarge.copyWith(\r\n+                          fontWeight: FontWeight.w600,\r\n+                        ),\r\n+                      ),\r\n+                      Text(\r\n+                        match.itemTitle,\r\n+                        style: AppTextStyles.caption,\r\n+                        maxLines: 1,\r\n+                        overflow: TextOverflow.ellipsis,\r\n+                      ),\r\n+                    ],\r\n+                  ),\r\n+                ),\r\n+              ],\r\n+            );\r\n+          }\r\n+          return const Text('Chat');\r\n+        },\r\n+      ),\r\n+      actions: [\r\n+        IconButton(\r\n+          icon: const Icon(Icons.info_outline),\r\n+          onPressed: () {\r\n+            // Show match details\r\n+          },\r\n+        ),\r\n+      ],\r\n+    );\r\n+  }\r\n+\r\n+  Widget _buildEmptyChat() {\r\n+    return Center(\r\n+      child: Column(\r\n+        mainAxisAlignment: MainAxisAlignment.center,\r\n+        children: [\r\n+          const Icon(\r\n+            Icons.chat_bubble_outline,\r\n+            size: 80,\r\n+            color: AppColors.grey300,\r\n+          ),\r\n+          const SizedBox(height: 16),\r\n+          Text(\r\n+            'No messages yet',\r\n+            style: AppTextStyles.h5.copyWith(color: AppColors.grey500),\r\n+          ),\r\n+          const SizedBox(height: 8),\r\n+          Text(\r\n+            'Start the conversation!',\r\n+            style: AppTextStyles.bodyMedium.copyWith(color: AppColors.grey400),\r\n+          ),\r\n+        ],\r\n+      ),\r\n+    );\r\n+  }\r\n+\r\n+  Widget _buildDateSeparator(DateTime date) {\r\n+    String dateText;\r\n+    final now = DateTime.now();\r\n+    final today = DateTime(now.year, now.month, now.day);\r\n+    final messageDate = DateTime(date.year, date.month, date.day);\r\n+\r\n+    if (messageDate == today) {\r\n+      dateText = 'Today';\r\n+    } else if (messageDate == today.subtract(const Duration(days: 1))) {\r\n+      dateText = 'Yesterday';\r\n+    } else {\r\n+      dateText = '${date.day}/${date.month}/${date.year}';\r\n+    }\r\n+\r\n+    return Padding(\r\n+      padding: const EdgeInsets.symmetric(vertical: 16),\r\n+      child: Center(\r\n+        child: Container(\r\n+          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),\r\n+          decoration: BoxDecoration(\r\n+            color: AppColors.grey200,\r\n+            borderRadius: BorderRadius.circular(12),\r\n+          ),\r\n+          child: Text(\r\n+            dateText,\r\n+            style: AppTextStyles.caption,\r\n+          ),\r\n+        ),\r\n+      ),\r\n+    );\r\n+  }\r\n+\r\n+  bool _isSameDay(DateTime date1, DateTime date2) {\r\n+    return date1.year == date2.year &&\r\n+        date1.month == date2.month &&\r\n+        date1.day == date2.day;\r\n+  }\r\n+}\r\n"
                }
            ],
            "date": 1766327121759,
            "name": "Commit-0",
            "content": "\r\n"
        }
    ]
}