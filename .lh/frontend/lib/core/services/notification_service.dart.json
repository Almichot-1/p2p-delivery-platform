{
    "sourceFile": "frontend/lib/core/services/notification_service.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1766327024546,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766327353145,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,156 @@\n+import 'package:firebase_messaging/firebase_messaging.dart';\r\n+import 'package:flutter_local_notifications/flutter_local_notifications.dart';\r\n+import 'package:cloud_firestore/cloud_firestore.dart';\r\n+import 'firebase_service.dart';\r\n \r\n+class NotificationService {\r\n+  final FirebaseMessaging _messaging = FirebaseMessaging.instance;\r\n+  final FlutterLocalNotificationsPlugin _localNotifications =\r\n+      FlutterLocalNotificationsPlugin();\r\n+  final FirebaseService _firebaseService;\r\n+\r\n+  NotificationService(this._firebaseService);\r\n+\r\n+  Future<void> initialize() async {\r\n+    // Request permission\r\n+    final settings = await _messaging.requestPermission(\r\n+      alert: true,\r\n+      badge: true,\r\n+      sound: true,\r\n+      provisional: false,\r\n+    );\r\n+\r\n+    if (settings.authorizationStatus == AuthorizationStatus.authorized) {\r\n+      // Get FCM token\r\n+      final token = await _messaging.getToken();\r\n+      if (token != null) {\r\n+        await _saveToken(token);\r\n+      }\r\n+\r\n+      // Listen for token refresh\r\n+      _messaging.onTokenRefresh.listen(_saveToken);\r\n+    }\r\n+\r\n+    // Initialize local notifications\r\n+    await _initializeLocalNotifications();\r\n+\r\n+    // Handle foreground messages\r\n+    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);\r\n+\r\n+    // Handle background messages\r\n+    FirebaseMessaging.onBackgroundMessage(_handleBackgroundMessage);\r\n+\r\n+    // Handle notification taps\r\n+    FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);\r\n+  }\r\n+\r\n+  Future<void> _initializeLocalNotifications() async {\r\n+    const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');\r\n+    const iosSettings = DarwinInitializationSettings(\r\n+      requestAlertPermission: true,\r\n+      requestBadgePermission: true,\r\n+      requestSoundPermission: true,\r\n+    );\r\n+\r\n+    const settings = InitializationSettings(\r\n+      android: androidSettings,\r\n+      iOS: iosSettings,\r\n+    );\r\n+\r\n+    await _localNotifications.initialize(\r\n+      settings,\r\n+      onDidReceiveNotificationResponse: _onNotificationResponse,\r\n+    );\r\n+  }\r\n+\r\n+  Future<void> _saveToken(String token) async {\r\n+    final userId = _firebaseService.currentUserId;\r\n+    if (userId != null) {\r\n+      await _firebaseService.usersCollection.doc(userId).update({\r\n+        'fcmToken': token,\r\n+        'tokenUpdatedAt': FieldValue.serverTimestamp(),\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  void _handleForegroundMessage(RemoteMessage message) {\r\n+    final notification = message.notification;\r\n+    if (notification != null) {\r\n+      _showLocalNotification(\r\n+        id: message.hashCode,\r\n+        title: notification.title ?? 'Notification',\r\n+        body: notification.body ?? '',\r\n+        payload: message.data.toString(),\r\n+      );\r\n+    }\r\n+  }\r\n+\r\n+  static Future<void> _handleBackgroundMessage(RemoteMessage message) async {\r\n+    // Handle background message\r\n+    print('Background message: ${message.messageId}');\r\n+  }\r\n+\r\n+  void _handleNotificationTap(RemoteMessage message) {\r\n+    // Navigate based on message data\r\n+    final data = message.data;\r\n+    final type = data['type'];\r\n+    final id = data['id'];\r\n+\r\n+    // Handle navigation based on notification type\r\n+    switch (type) {\r\n+      case 'match':\r\n+        // Navigate to match details\r\n+        break;\r\n+      case 'message':\r\n+        // Navigate to chat\r\n+        break;\r\n+      case 'request':\r\n+        // Navigate to request details\r\n+        break;\r\n+    }\r\n+  }\r\n+\r\n+  void _onNotificationResponse(NotificationResponse response) {\r\n+    // Handle local notification tap\r\n+    if (response.payload != null) {\r\n+      // Parse payload and navigate\r\n+    }\r\n+  }\r\n+\r\n+  Future<void> _showLocalNotification({\r\n+    required int id,\r\n+    required String title,\r\n+    required String body,\r\n+    String? payload,\r\n+  }) async {\r\n+    const androidDetails = AndroidNotificationDetails(\r\n+      'diaspora_delivery',\r\n+      'Diaspora Delivery',\r\n+      channelDescription: 'Notifications for Diaspora Delivery app',\r\n+      importance: Importance.high,\r\n+      priority: Priority.high,\r\n+      showWhen: true,\r\n+    );\r\n+\r\n+    const iosDetails = DarwinNotificationDetails(\r\n+      presentAlert: true,\r\n+      presentBadge: true,\r\n+      presentSound: true,\r\n+    );\r\n+\r\n+    const details = NotificationDetails(\r\n+      android: androidDetails,\r\n+      iOS: iosDetails,\r\n+    );\r\n+\r\n+    await _localNotifications.show(id, title, body, details, payload: payload);\r\n+  }\r\n+\r\n+  Future<void> subscribeToTopic(String topic) async {\r\n+    await _messaging.subscribeToTopic(topic);\r\n+  }\r\n+\r\n+  Future<void> unsubscribeFromTopic(String topic) async {\r\n+    await _messaging.unsubscribeFromTopic(topic);\r\n+  }\r\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766346614510,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,9 +44,10 @@\n     FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);\r\n   }\r\n \r\n   Future<void> _initializeLocalNotifications() async {\r\n-    const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');\r\n+    const androidSettings =\r\n+        AndroidInitializationSettings('@mipmap/ic_launcher');\r\n     const iosSettings = DarwinInitializationSettings(\r\n       requestAlertPermission: true,\r\n       requestBadgePermission: true,\r\n       requestSoundPermission: true,\r\n@@ -86,16 +87,18 @@\n   }\r\n \r\n   static Future<void> _handleBackgroundMessage(RemoteMessage message) async {\r\n     // Handle background message\r\n-    print('Background message: ${message.messageId}');\r\n+    if (kDebugMode) {\r\n+      debugPrint('Background message: ${message.messageId}');\r\n+    }\r\n   }\r\n \r\n   void _handleNotificationTap(RemoteMessage message) {\r\n     // Navigate based on message data\r\n     final data = message.data;\r\n     final type = data['type'];\r\n-    final id = data['id'];\r\n+    // final id = data['id']; // Removed unused local variable\r\n \r\n     // Handle navigation based on notification type\r\n     switch (type) {\r\n       case 'match':\r\n@@ -152,5 +155,5 @@\n \r\n   Future<void> unsubscribeFromTopic(String topic) async {\r\n     await _messaging.unsubscribeFromTopic(topic);\r\n   }\r\n-}\n\\ No newline at end of file\n+}\r\n"
                },
                {
                    "date": 1766346625283,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,159 @@\n+import 'package:firebase_messaging/firebase_messaging.dart';\r\n+import 'package:flutter/foundation.dart';\r\n+import 'package:flutter_local_notifications/flutter_local_notifications.dart';\r\n+import 'package:cloud_firestore/cloud_firestore.dart';\r\n+import 'firebase_service.dart';\r\n+\r\n+class NotificationService {\r\n+  final FirebaseMessaging _messaging = FirebaseMessaging.instance;\r\n+  final FlutterLocalNotificationsPlugin _localNotifications =\r\n+      FlutterLocalNotificationsPlugin();\r\n+  final FirebaseService _firebaseService;\r\n+\r\n+  NotificationService(this._firebaseService);\r\n+\r\n+  Future<void> initialize() async {\r\n+    // Request permission\r\n+    final settings = await _messaging.requestPermission(\r\n+      alert: true,\r\n+      badge: true,\r\n+      sound: true,\r\n+      provisional: false,\r\n+    );\r\n+\r\n+    if (settings.authorizationStatus == AuthorizationStatus.authorized) {\r\n+      // Get FCM token\r\n+      final token = await _messaging.getToken();\r\n+      if (token != null) {\r\n+        await _saveToken(token);\r\n+      }\r\n+\r\n+      // Listen for token refresh\r\n+      _messaging.onTokenRefresh.listen(_saveToken);\r\n+    }\r\n+\r\n+    // Initialize local notifications\r\n+    await _initializeLocalNotifications();\r\n+\r\n+    // Handle foreground messages\r\n+    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);\r\n+\r\n+    // Handle background messages\r\n+    FirebaseMessaging.onBackgroundMessage(_handleBackgroundMessage);\r\n+\r\n+    // Handle notification taps\r\n+    FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);\r\n+  }\r\n+\r\n+  Future<void> _initializeLocalNotifications() async {\r\n+    const androidSettings =\r\n+        AndroidInitializationSettings('@mipmap/ic_launcher');\r\n+    const iosSettings = DarwinInitializationSettings(\r\n+      requestAlertPermission: true,\r\n+      requestBadgePermission: true,\r\n+      requestSoundPermission: true,\r\n+    );\r\n+\r\n+    const settings = InitializationSettings(\r\n+      android: androidSettings,\r\n+      iOS: iosSettings,\r\n+    );\r\n+\r\n+    await _localNotifications.initialize(\r\n+      settings,\r\n+      onDidReceiveNotificationResponse: _onNotificationResponse,\r\n+    );\r\n+  }\r\n+\r\n+  Future<void> _saveToken(String token) async {\r\n+    final userId = _firebaseService.currentUserId;\r\n+    if (userId != null) {\r\n+      await _firebaseService.usersCollection.doc(userId).update({\r\n+        'fcmToken': token,\r\n+        'tokenUpdatedAt': FieldValue.serverTimestamp(),\r\n+      });\r\n+    }\r\n+  }\r\n+\r\n+  void _handleForegroundMessage(RemoteMessage message) {\r\n+    final notification = message.notification;\r\n+    if (notification != null) {\r\n+      _showLocalNotification(\r\n+        id: message.hashCode,\r\n+        title: notification.title ?? 'Notification',\r\n+        body: notification.body ?? '',\r\n+        payload: message.data.toString(),\r\n+      );\r\n+    }\r\n+  }\r\n+\r\n+  static Future<void> _handleBackgroundMessage(RemoteMessage message) async {\r\n+    // Handle background message\r\n+    if (kDebugMode) {\r\n+      debugPrint('Background message: ${message.messageId}');\r\n+    }\r\n+  }\r\n+\r\n+  void _handleNotificationTap(RemoteMessage message) {\r\n+    // Navigate based on message data\r\n+    final data = message.data;\r\n+    final type = data['type'];\r\n+\r\n+    // Handle navigation based on notification type\r\n+    switch (type) {\r\n+      case 'match':\r\n+        // Navigate to match details\r\n+        break;\r\n+      case 'message':\r\n+        // Navigate to chat\r\n+        break;\r\n+      case 'request':\r\n+        // Navigate to request details\r\n+        break;\r\n+    }\r\n+  }\r\n+\r\n+  void _onNotificationResponse(NotificationResponse response) {\r\n+    // Handle local notification tap\r\n+    if (response.payload != null) {\r\n+      // Parse payload and navigate\r\n+    }\r\n+  }\r\n+\r\n+  Future<void> _showLocalNotification({\r\n+    required int id,\r\n+    required String title,\r\n+    required String body,\r\n+    String? payload,\r\n+  }) async {\r\n+    const androidDetails = AndroidNotificationDetails(\r\n+      'diaspora_delivery',\r\n+      'Diaspora Delivery',\r\n+      channelDescription: 'Notifications for Diaspora Delivery app',\r\n+      importance: Importance.high,\r\n+      priority: Priority.high,\r\n+      showWhen: true,\r\n+    );\r\n+\r\n+    const iosDetails = DarwinNotificationDetails(\r\n+      presentAlert: true,\r\n+      presentBadge: true,\r\n+      presentSound: true,\r\n+    );\r\n+\r\n+    const details = NotificationDetails(\r\n+      android: androidDetails,\r\n+      iOS: iosDetails,\r\n+    );\r\n+\r\n+    await _localNotifications.show(id, title, body, details, payload: payload);\r\n+  }\r\n+\r\n+  Future<void> subscribeToTopic(String topic) async {\r\n+    await _messaging.subscribeToTopic(topic);\r\n+  }\r\n+\r\n+  Future<void> unsubscribeFromTopic(String topic) async {\r\n+    await _messaging.unsubscribeFromTopic(topic);\r\n+  }\r\n+}\r\n"
                },
                {
                    "date": 1766593908322,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -66,174 +66,25 @@\n   }\r\n \r\n   Future<void> _saveToken(String token) async {\r\n     final userId = _firebaseService.currentUserId;\r\n-    if (userId != null) {\r\n-      await _firebaseService.usersCollection.doc(userId).update({\r\n-        'fcmToken': token,\r\n-        'tokenUpdatedAt': FieldValue.serverTimestamp(),\r\n-      });\r\n-    }\r\n-  }\r\n+    if (userId == null) return;\r\n \r\n-  void _handleForegroundMessage(RemoteMessage message) {\r\n-    final notification = message.notification;\r\n-    if (notification != null) {\r\n-      _showLocalNotification(\r\n-        id: message.hashCode,\r\n-        title: notification.title ?? 'Notification',\r\n-        body: notification.body ?? '',\r\n-        payload: message.data.toString(),\r\n+    try {\r\n+      await _firebaseService.usersCollection.doc(userId).set(\r\n+        {\r\n+          'fcmToken': token,\r\n+          'tokenUpdatedAt': FieldValue.serverTimestamp(),\r\n+        },\r\n+        SetOptions(merge: true),\r\n       );\r\n-    }\r\n-  }\r\n-\r\n-  static Future<void> _handleBackgroundMessage(RemoteMessage message) async {\r\n-    // Handle background message\r\n-    if (kDebugMode) {\r\n-      debugPrint('Background message: ${message.messageId}');\r\n-    }\r\n-  }\r\n-\r\n-  void _handleNotificationTap(RemoteMessage message) {\r\n-    // Navigate based on message data\r\n-    final data = message.data;\r\n-    final type = data['type'];\r\n-\r\n-    // Handle navigation based on notification type\r\n-    switch (type) {\r\n-      case 'match':\r\n-        // Navigate to match details\r\n-        break;\r\n-      case 'message':\r\n-        // Navigate to chat\r\n-        break;\r\n-      case 'request':\r\n-        // Navigate to request details\r\n-        break;\r\n-    }\r\n-  }\r\n-\r\n-  void _onNotificationResponse(NotificationResponse response) {\r\n-    // Handle local notification tap\r\n-    if (response.payload != null) {\r\n-      // Parse payload and navigate\r\n-    }\r\n-  }\r\n-\r\n-  Future<void> _showLocalNotification({\r\n-    required int id,\r\n-    required String title,\r\n-    required String body,\r\n-    String? payload,\r\n-  }) async {\r\n-    const androidDetails = AndroidNotificationDetails(\r\n-      'diaspora_delivery',\r\n-      'Diaspora Delivery',\r\n-      channelDescription: 'Notifications for Diaspora Delivery app',\r\n-      importance: Importance.high,\r\n-      priority: Priority.high,\r\n-      showWhen: true,\r\n-    );\r\n-\r\n-    const iosDetails = DarwinNotificationDetails(\r\n-      presentAlert: true,\r\n-      presentBadge: true,\r\n-      presentSound: true,\r\n-    );\r\n-\r\n-    const details = NotificationDetails(\r\n-      android: androidDetails,\r\n-      iOS: iosDetails,\r\n-    );\r\n-\r\n-    await _localNotifications.show(id, title, body, details, payload: payload);\r\n-  }\r\n-\r\n-  Future<void> subscribeToTopic(String topic) async {\r\n-    await _messaging.subscribeToTopic(topic);\r\n-  }\r\n-\r\n-  Future<void> unsubscribeFromTopic(String topic) async {\r\n-    await _messaging.unsubscribeFromTopic(topic);\r\n-  }\r\n-}\r\n-import 'package:firebase_messaging/firebase_messaging.dart';\r\n-import 'package:flutter_local_notifications/flutter_local_notifications.dart';\r\n-import 'package:cloud_firestore/cloud_firestore.dart';\r\n-import 'firebase_service.dart';\r\n-\r\n-class NotificationService {\r\n-  final FirebaseMessaging _messaging = FirebaseMessaging.instance;\r\n-  final FlutterLocalNotificationsPlugin _localNotifications =\r\n-      FlutterLocalNotificationsPlugin();\r\n-  final FirebaseService _firebaseService;\r\n-\r\n-  NotificationService(this._firebaseService);\r\n-\r\n-  Future<void> initialize() async {\r\n-    // Request permission\r\n-    final settings = await _messaging.requestPermission(\r\n-      alert: true,\r\n-      badge: true,\r\n-      sound: true,\r\n-      provisional: false,\r\n-    );\r\n-\r\n-    if (settings.authorizationStatus == AuthorizationStatus.authorized) {\r\n-      // Get FCM token\r\n-      final token = await _messaging.getToken();\r\n-      if (token != null) {\r\n-        await _saveToken(token);\r\n+    } catch (error, stackTrace) {\r\n+      if (kDebugMode) {\r\n+        debugPrint('Failed to save FCM token: $error\\n$stackTrace');\r\n       }\r\n-\r\n-      // Listen for token refresh\r\n-      _messaging.onTokenRefresh.listen(_saveToken);\r\n     }\r\n-\r\n-    // Initialize local notifications\r\n-    await _initializeLocalNotifications();\r\n-\r\n-    // Handle foreground messages\r\n-    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);\r\n-\r\n-    // Handle background messages\r\n-    FirebaseMessaging.onBackgroundMessage(_handleBackgroundMessage);\r\n-\r\n-    // Handle notification taps\r\n-    FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);\r\n   }\r\n \r\n-  Future<void> _initializeLocalNotifications() async {\r\n-    const androidSettings =\r\n-        AndroidInitializationSettings('@mipmap/ic_launcher');\r\n-    const iosSettings = DarwinInitializationSettings(\r\n-      requestAlertPermission: true,\r\n-      requestBadgePermission: true,\r\n-      requestSoundPermission: true,\r\n-    );\r\n-\r\n-    const settings = InitializationSettings(\r\n-      android: androidSettings,\r\n-      iOS: iosSettings,\r\n-    );\r\n-\r\n-    await _localNotifications.initialize(\r\n-      settings,\r\n-      onDidReceiveNotificationResponse: _onNotificationResponse,\r\n-    );\r\n-  }\r\n-\r\n-  Future<void> _saveToken(String token) async {\r\n-    final userId = _firebaseService.currentUserId;\r\n-    if (userId != null) {\r\n-      await _firebaseService.usersCollection.doc(userId).update({\r\n-        'fcmToken': token,\r\n-        'tokenUpdatedAt': FieldValue.serverTimestamp(),\r\n-      });\r\n-    }\r\n-  }\r\n-\r\n   void _handleForegroundMessage(RemoteMessage message) {\r\n     final notification = message.notification;\r\n     if (notification != null) {\r\n       _showLocalNotification(\r\n@@ -255,9 +106,8 @@\n   void _handleNotificationTap(RemoteMessage message) {\r\n     // Navigate based on message data\r\n     final data = message.data;\r\n     final type = data['type'];\r\n-    // final id = data['id']; // Removed unused local variable\r\n \r\n     // Handle navigation based on notification type\r\n     switch (type) {\r\n       case 'match':\r\n"
                },
                {
                    "date": 1766594745536,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,186 @@\n+import 'package:firebase_messaging/firebase_messaging.dart';\r\n+import 'package:flutter/foundation.dart';\r\n+import 'package:flutter_local_notifications/flutter_local_notifications.dart';\r\n+import 'package:cloud_firestore/cloud_firestore.dart';\r\n+import 'firebase_service.dart';\r\n+\r\n+class NotificationService {\r\n+  final FirebaseMessaging _messaging = FirebaseMessaging.instance;\r\n+  final FlutterLocalNotificationsPlugin _localNotifications =\r\n+      FlutterLocalNotificationsPlugin();\r\n+  final FirebaseService _firebaseService;\r\n+\r\n+  NotificationService(this._firebaseService);\r\n+\r\n+  Future<void> initialize() async {\r\n+    // Request permission\r\n+    final settings = await _messaging.requestPermission(\r\n+      alert: true,\r\n+      badge: true,\r\n+      sound: true,\r\n+      provisional: false,\r\n+    );\r\n+\r\n+    if (settings.authorizationStatus == AuthorizationStatus.authorized) {\r\n+      // Get FCM token\r\n+      final token = await _messaging.getToken();\r\n+      if (token != null) {\r\n+        try {\r\n+          await _saveToken(token);\r\n+        } catch (error, stackTrace) {\r\n+          if (kDebugMode) {\r\n+            debugPrint(\r\n+              'Failed to save initial FCM token (non-fatal): $error\\n$stackTrace',\r\n+            );\r\n+          }\r\n+        }\r\n+      }\r\n+\r\n+      // Listen for token refresh\r\n+      _messaging.onTokenRefresh.listen((token) async {\r\n+        try {\r\n+          await _saveToken(token);\r\n+        } catch (error, stackTrace) {\r\n+          if (kDebugMode) {\r\n+            debugPrint(\r\n+              'Failed to save refreshed FCM token (non-fatal): $error\\n$stackTrace',\r\n+            );\r\n+          }\r\n+        }\r\n+      });\r\n+    }\r\n+\r\n+    // Initialize local notifications\r\n+    await _initializeLocalNotifications();\r\n+\r\n+    // Handle foreground messages\r\n+    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);\r\n+\r\n+    // Handle background messages\r\n+    FirebaseMessaging.onBackgroundMessage(_handleBackgroundMessage);\r\n+\r\n+    // Handle notification taps\r\n+    FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);\r\n+  }\r\n+\r\n+  Future<void> _initializeLocalNotifications() async {\r\n+    const androidSettings =\r\n+        AndroidInitializationSettings('@mipmap/ic_launcher');\r\n+    const iosSettings = DarwinInitializationSettings(\r\n+      requestAlertPermission: true,\r\n+      requestBadgePermission: true,\r\n+      requestSoundPermission: true,\r\n+    );\r\n+\r\n+    const settings = InitializationSettings(\r\n+      android: androidSettings,\r\n+      iOS: iosSettings,\r\n+    );\r\n+\r\n+    await _localNotifications.initialize(\r\n+      settings,\r\n+      onDidReceiveNotificationResponse: _onNotificationResponse,\r\n+    );\r\n+  }\r\n+\r\n+  Future<void> _saveToken(String token) async {\r\n+    final userId = _firebaseService.currentUserId;\r\n+    if (userId == null) return;\r\n+\r\n+    try {\r\n+      await _firebaseService.usersCollection.doc(userId).set(\r\n+        {\r\n+          'fcmToken': token,\r\n+          'tokenUpdatedAt': FieldValue.serverTimestamp(),\r\n+        },\r\n+        SetOptions(merge: true),\r\n+      );\r\n+    } catch (error, stackTrace) {\r\n+      if (kDebugMode) {\r\n+        debugPrint('Failed to save FCM token: $error\\n$stackTrace');\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  void _handleForegroundMessage(RemoteMessage message) {\r\n+    final notification = message.notification;\r\n+    if (notification != null) {\r\n+      _showLocalNotification(\r\n+        id: message.hashCode,\r\n+        title: notification.title ?? 'Notification',\r\n+        body: notification.body ?? '',\r\n+        payload: message.data.toString(),\r\n+      );\r\n+    }\r\n+  }\r\n+\r\n+  static Future<void> _handleBackgroundMessage(RemoteMessage message) async {\r\n+    // Handle background message\r\n+    if (kDebugMode) {\r\n+      debugPrint('Background message: ${message.messageId}');\r\n+    }\r\n+  }\r\n+\r\n+  void _handleNotificationTap(RemoteMessage message) {\r\n+    // Navigate based on message data\r\n+    final data = message.data;\r\n+    final type = data['type'];\r\n+\r\n+    // Handle navigation based on notification type\r\n+    switch (type) {\r\n+      case 'match':\r\n+        // Navigate to match details\r\n+        break;\r\n+      case 'message':\r\n+        // Navigate to chat\r\n+        break;\r\n+      case 'request':\r\n+        // Navigate to request details\r\n+        break;\r\n+    }\r\n+  }\r\n+\r\n+  void _onNotificationResponse(NotificationResponse response) {\r\n+    // Handle local notification tap\r\n+    if (response.payload != null) {\r\n+      // Parse payload and navigate\r\n+    }\r\n+  }\r\n+\r\n+  Future<void> _showLocalNotification({\r\n+    required int id,\r\n+    required String title,\r\n+    required String body,\r\n+    String? payload,\r\n+  }) async {\r\n+    const androidDetails = AndroidNotificationDetails(\r\n+      'diaspora_delivery',\r\n+      'Diaspora Delivery',\r\n+      channelDescription: 'Notifications for Diaspora Delivery app',\r\n+      importance: Importance.high,\r\n+      priority: Priority.high,\r\n+      showWhen: true,\r\n+    );\r\n+\r\n+    const iosDetails = DarwinNotificationDetails(\r\n+      presentAlert: true,\r\n+      presentBadge: true,\r\n+      presentSound: true,\r\n+    );\r\n+\r\n+    const details = NotificationDetails(\r\n+      android: androidDetails,\r\n+      iOS: iosDetails,\r\n+    );\r\n+\r\n+    await _localNotifications.show(id, title, body, details, payload: payload);\r\n+  }\r\n+\r\n+  Future<void> subscribeToTopic(String topic) async {\r\n+    await _messaging.subscribeToTopic(topic);\r\n+  }\r\n+\r\n+  Future<void> unsubscribeFromTopic(String topic) async {\r\n+    await _messaging.unsubscribeFromTopic(topic);\r\n+  }\r\n+}\r\n"
                },
                {
                    "date": 1766594843527,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,189 @@\n+import 'package:firebase_messaging/firebase_messaging.dart';\r\n+import 'package:flutter/foundation.dart';\r\n+import 'package:flutter_local_notifications/flutter_local_notifications.dart';\r\n+import 'package:cloud_firestore/cloud_firestore.dart';\r\n+import 'firebase_service.dart';\r\n+\r\n+class NotificationService {\r\n+  final FirebaseMessaging _messaging = FirebaseMessaging.instance;\r\n+  final FlutterLocalNotificationsPlugin _localNotifications =\r\n+      FlutterLocalNotificationsPlugin();\r\n+  final FirebaseService _firebaseService;\r\n+\r\n+  NotificationService(this._firebaseService);\r\n+\r\n+  Future<void> initialize() async {\r\n+    if (kDebugMode) {\r\n+      debugPrint('NotificationService.initialize marker: 2025-12-24');\r\n+    }\r\n+    // Request permission\r\n+    final settings = await _messaging.requestPermission(\r\n+      alert: true,\r\n+      badge: true,\r\n+      sound: true,\r\n+      provisional: false,\r\n+    );\r\n+\r\n+    if (settings.authorizationStatus == AuthorizationStatus.authorized) {\r\n+      // Get FCM token\r\n+      final token = await _messaging.getToken();\r\n+      if (token != null) {\r\n+        try {\r\n+          await _saveToken(token);\r\n+        } catch (error, stackTrace) {\r\n+          if (kDebugMode) {\r\n+            debugPrint(\r\n+              'Failed to save initial FCM token (non-fatal): $error\\n$stackTrace',\r\n+            );\r\n+          }\r\n+        }\r\n+      }\r\n+\r\n+      // Listen for token refresh\r\n+      _messaging.onTokenRefresh.listen((token) async {\r\n+        try {\r\n+          await _saveToken(token);\r\n+        } catch (error, stackTrace) {\r\n+          if (kDebugMode) {\r\n+            debugPrint(\r\n+              'Failed to save refreshed FCM token (non-fatal): $error\\n$stackTrace',\r\n+            );\r\n+          }\r\n+        }\r\n+      });\r\n+    }\r\n+\r\n+    // Initialize local notifications\r\n+    await _initializeLocalNotifications();\r\n+\r\n+    // Handle foreground messages\r\n+    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);\r\n+\r\n+    // Handle background messages\r\n+    FirebaseMessaging.onBackgroundMessage(_handleBackgroundMessage);\r\n+\r\n+    // Handle notification taps\r\n+    FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);\r\n+  }\r\n+\r\n+  Future<void> _initializeLocalNotifications() async {\r\n+    const androidSettings =\r\n+        AndroidInitializationSettings('@mipmap/ic_launcher');\r\n+    const iosSettings = DarwinInitializationSettings(\r\n+      requestAlertPermission: true,\r\n+      requestBadgePermission: true,\r\n+      requestSoundPermission: true,\r\n+    );\r\n+\r\n+    const settings = InitializationSettings(\r\n+      android: androidSettings,\r\n+      iOS: iosSettings,\r\n+    );\r\n+\r\n+    await _localNotifications.initialize(\r\n+      settings,\r\n+      onDidReceiveNotificationResponse: _onNotificationResponse,\r\n+    );\r\n+  }\r\n+\r\n+  Future<void> _saveToken(String token) async {\r\n+    final userId = _firebaseService.currentUserId;\r\n+    if (userId == null) return;\r\n+\r\n+    try {\r\n+      await _firebaseService.usersCollection.doc(userId).set(\r\n+        {\r\n+          'fcmToken': token,\r\n+          'tokenUpdatedAt': FieldValue.serverTimestamp(),\r\n+        },\r\n+        SetOptions(merge: true),\r\n+      );\r\n+    } catch (error, stackTrace) {\r\n+      if (kDebugMode) {\r\n+        debugPrint('Failed to save FCM token: $error\\n$stackTrace');\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  void _handleForegroundMessage(RemoteMessage message) {\r\n+    final notification = message.notification;\r\n+    if (notification != null) {\r\n+      _showLocalNotification(\r\n+        id: message.hashCode,\r\n+        title: notification.title ?? 'Notification',\r\n+        body: notification.body ?? '',\r\n+        payload: message.data.toString(),\r\n+      );\r\n+    }\r\n+  }\r\n+\r\n+  static Future<void> _handleBackgroundMessage(RemoteMessage message) async {\r\n+    // Handle background message\r\n+    if (kDebugMode) {\r\n+      debugPrint('Background message: ${message.messageId}');\r\n+    }\r\n+  }\r\n+\r\n+  void _handleNotificationTap(RemoteMessage message) {\r\n+    // Navigate based on message data\r\n+    final data = message.data;\r\n+    final type = data['type'];\r\n+\r\n+    // Handle navigation based on notification type\r\n+    switch (type) {\r\n+      case 'match':\r\n+        // Navigate to match details\r\n+        break;\r\n+      case 'message':\r\n+        // Navigate to chat\r\n+        break;\r\n+      case 'request':\r\n+        // Navigate to request details\r\n+        break;\r\n+    }\r\n+  }\r\n+\r\n+  void _onNotificationResponse(NotificationResponse response) {\r\n+    // Handle local notification tap\r\n+    if (response.payload != null) {\r\n+      // Parse payload and navigate\r\n+    }\r\n+  }\r\n+\r\n+  Future<void> _showLocalNotification({\r\n+    required int id,\r\n+    required String title,\r\n+    required String body,\r\n+    String? payload,\r\n+  }) async {\r\n+    const androidDetails = AndroidNotificationDetails(\r\n+      'diaspora_delivery',\r\n+      'Diaspora Delivery',\r\n+      channelDescription: 'Notifications for Diaspora Delivery app',\r\n+      importance: Importance.high,\r\n+      priority: Priority.high,\r\n+      showWhen: true,\r\n+    );\r\n+\r\n+    const iosDetails = DarwinNotificationDetails(\r\n+      presentAlert: true,\r\n+      presentBadge: true,\r\n+      presentSound: true,\r\n+    );\r\n+\r\n+    const details = NotificationDetails(\r\n+      android: androidDetails,\r\n+      iOS: iosDetails,\r\n+    );\r\n+\r\n+    await _localNotifications.show(id, title, body, details, payload: payload);\r\n+  }\r\n+\r\n+  Future<void> subscribeToTopic(String topic) async {\r\n+    await _messaging.subscribeToTopic(topic);\r\n+  }\r\n+\r\n+  Future<void> unsubscribeFromTopic(String topic) async {\r\n+    await _messaging.unsubscribeFromTopic(topic);\r\n+  }\r\n+}\r\n"
                }
            ],
            "date": 1766327024546,
            "name": "Commit-0",
            "content": "\r\n"
        }
    ]
}