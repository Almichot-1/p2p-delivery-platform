{
    "sourceFile": "lib/features/requests/presentation/screens/create_request_screen.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1768056590173,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1768056780209,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -394,11 +394,11 @@\n                         if (_isFromTrip) ...[\r\n                           Container(\r\n                             padding: const EdgeInsets.all(12),\r\n                             decoration: BoxDecoration(\r\n-                                color: Theme.of(context).colorScheme.primaryContainer.withOpacity(0.3),\r\n+                                color: Theme.of(context).colorScheme.primaryContainer.withAlpha((0.3 * 255).round()),\r\n                                 borderRadius: BorderRadius.circular(8),\r\n-                                border: Border.all(color: Theme.of(context).colorScheme.primary.withOpacity(0.3))\r\n+                                border: Border.all(color: Theme.of(context).colorScheme.primary.withAlpha((0.3 * 255).round()))\r\n                             ),\r\n                             child: Row(\r\n                               children: [\r\n                                 const Icon(Icons.info_outline, size: 20),\r\n@@ -410,8 +410,15 @@\n                               ],\r\n                             ),\r\n                           ),\r\n                           const SizedBox(height: 16),\r\n+\r\n+                          Text('Trip Route', style: Theme.of(context).textTheme.titleMedium),\r\n+                          const SizedBox(height: 12),\r\n+                          _buildLockedLocation(_pickupCity, _pickupCountry, labelText: 'Pickup (from trip)'),\r\n+                          const SizedBox(height: 12),\r\n+                          _buildLockedLocation(_deliveryCity, _deliveryCountry, labelText: 'Delivery (from trip)'),\r\n+                          const SizedBox(height: 20),\r\n                         ],\r\n \r\n                         // Item details\r\n                         Text('What are you sending?', style: Theme.of(context).textTheme.titleMedium),\r\n@@ -429,9 +436,9 @@\n                         Row(\r\n                           children: [\r\n                             Expanded(\r\n                               child: DropdownButtonFormField<RequestCategory>(\r\n-                                value: _category,\r\n+                                initialValue: _category,\r\n                                 decoration: const InputDecoration(\r\n                                   labelText: 'Category *',\r\n                                   border: OutlineInputBorder(),\r\n                                 ),\r\n@@ -608,36 +615,21 @@\n     ),\r\n     );\r\n   }\r\n \r\n-  Widget _buildLockedLocation(String? city, String? country) {\r\n+  Widget _buildLockedLocation(String? city, String? country, {required String labelText}) {\r\n     return TextFormField(\r\n       initialValue: '$city, $country',\r\n       readOnly: true,\r\n       enabled: false,\r\n       decoration: const InputDecoration(\r\n+        labelText: labelText,\r\n         border: OutlineInputBorder(),\r\n         filled: true,\r\n       ),\r\n     );\r\n   }\r\n \r\n-  Widget _buildLockedDate() {\r\n-    final d = _preferredDeliveryDate;\r\n-    final text = d != null ? '${d.day}/${d.month}/${d.year}' : 'Any';\r\n-    return TextFormField(\r\n-      initialValue: text,\r\n-      readOnly: true,\r\n-      enabled: false,\r\n-      decoration: const InputDecoration(\r\n-        labelText: 'Date (Matched to Trip)',\r\n-        border: OutlineInputBorder(),\r\n-        filled: true,\r\n-        prefixIcon: Icon(Icons.calendar_today),\r\n-      ),\r\n-    );\r\n-  }\r\n-\r\n   Widget _buildLocationSection({required bool isPickup, required bool enabled}) {\r\n     final country = isPickup ? _pickupCountry : _deliveryCountry;\r\n     final city = isPickup ? _pickupCity : _deliveryCity;\r\n     final cityCtrl = isPickup ? _pickupCityCtrl : _deliveryCityCtrl;\r\n@@ -646,9 +638,9 @@\n \r\n     return Column(\r\n       children: [\r\n         DropdownButtonFormField<String>(\r\n-          value: country != null && _countries.contains(country) ? country : null,\r\n+          initialValue: country != null && _countries.contains(country) ? country : null,\r\n           decoration: const InputDecoration(\r\n             labelText: 'Country *',\r\n             border: OutlineInputBorder(),\r\n           ),\r\n@@ -672,9 +664,9 @@\n         const SizedBox(height: 12),\r\n \r\n         if (cities.isNotEmpty && !showManualInput)\r\n           DropdownButtonFormField<String>(\r\n-            value: city != null && cities.contains(city) ? city : null,\r\n+            initialValue: city != null && cities.contains(city) ? city : null,\r\n             decoration: const InputDecoration(\r\n               labelText: 'City *',\r\n               border: OutlineInputBorder(),\r\n             ),\r\n"
                },
                {
                    "date": 1768056805395,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -620,9 +620,9 @@\n     return TextFormField(\r\n       initialValue: '$city, $country',\r\n       readOnly: true,\r\n       enabled: false,\r\n-      decoration: const InputDecoration(\r\n+      decoration: InputDecoration(\r\n         labelText: labelText,\r\n         border: OutlineInputBorder(),\r\n         filled: true,\r\n       ),\r\n"
                },
                {
                    "date": 1768062369354,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -110,8 +110,15 @@\n   bool get _isFromTrip => widget.fromTrip != null;\r\n   TripModel? get _linkedTrip => widget.fromTrip?.trip;\r\n   List<String> get _countries => _countryCities.keys.toList();\r\n \r\n+  bool get _tripAllowsContact {\r\n+    if (!_isFromTrip) return true;\r\n+    final trip = _linkedTrip;\r\n+    if (trip == null) return false;\r\n+    return trip.isUpcoming;\r\n+  }\r\n+\r\n   List<String> _getCities(String? country) {\r\n     if (country == null || country == 'Other') return [];\r\n     return _countryCities[country] ?? [];\r\n   }\r\n@@ -205,8 +212,14 @@\n     if (picked != null) setState(() => _preferredDeliveryDate = picked);\r\n   }\r\n \r\n   void _submit(BuildContext blocContext) {\r\n+    if (!_tripAllowsContact) {\r\n+      ScaffoldMessenger.of(context).showSnackBar(\r\n+        const SnackBar(content: Text('This trip has already passed. Please choose an upcoming trip.')),\r\n+      );\r\n+      return;\r\n+    }\r\n     if (!_formKey.currentState!.validate()) return;\r\n     if (_category == null) {\r\n       ScaffoldMessenger.of(context).showSnackBar(\r\n         const SnackBar(content: Text('Please select a category')),\r\n@@ -409,8 +422,33 @@\n                                 )),\r\n                               ],\r\n                             ),\r\n                           ),\r\n+                          if (!_tripAllowsContact) ...[\r\n+                            const SizedBox(height: 12),\r\n+                            Container(\r\n+                              padding: const EdgeInsets.all(12),\r\n+                              decoration: BoxDecoration(\r\n+                                color: Theme.of(context).colorScheme.errorContainer.withAlpha((0.35 * 255).round()),\r\n+                                borderRadius: BorderRadius.circular(8),\r\n+                                border: Border.all(\r\n+                                  color: Theme.of(context).colorScheme.error.withAlpha((0.35 * 255).round()),\r\n+                                ),\r\n+                              ),\r\n+                              child: Row(\r\n+                                children: [\r\n+                                  Icon(Icons.block, size: 20, color: Theme.of(context).colorScheme.error),\r\n+                                  const SizedBox(width: 8),\r\n+                                  Expanded(\r\n+                                    child: Text(\r\n+                                      'This trip is no longer available (date already passed). You can’t contact the traveler for this trip.',\r\n+                                      style: Theme.of(context).textTheme.bodySmall,\r\n+                                    ),\r\n+                                  ),\r\n+                                ],\r\n+                              ),\r\n+                            ),\r\n+                          ],\r\n                           const SizedBox(height: 16),\r\n \r\n                           Text('Trip Route', style: Theme.of(context).textTheme.titleMedium),\r\n                           const SizedBox(height: 12),\r\n@@ -590,15 +628,19 @@\n                         BlocBuilder<MatchBloc, MatchState>(\r\n                           builder: (context, matchState) {\r\n                              final matchLoading = matchState is MatchCreating;\r\n                              return FilledButton.icon(\r\n-                              onPressed: (submitting || matchLoading) ? null : () => _submit(context),\r\n+                              onPressed: (submitting || matchLoading || !_tripAllowsContact)\r\n+                                  ? null\r\n+                                  : () => _submit(context),\r\n                               icon: const Icon(Icons.send),\r\n                               label: Text(\r\n                                 _isEdit\r\n                                     ? 'Save Changes'\r\n                                     : (_isFromTrip\r\n-                                        ? (matchLoading ? 'Sending...' : 'Send to Traveler')\r\n+                                        ? (!_tripAllowsContact\r\n+                                            ? 'Trip ended'\r\n+                                            : (matchLoading ? 'Sending...' : 'Send to Traveler'))\r\n                                         : 'Create Request'),\r\n                               ),\r\n                             ); \r\n                           }\r\n"
                }
            ],
            "date": 1768056590173,
            "name": "Commit-0",
            "content": "import 'dart:io';\r\n\r\nimport 'package:flutter/material.dart';\r\nimport 'package:flutter_bloc/flutter_bloc.dart';\r\nimport 'package:get_it/get_it.dart';\r\nimport 'package:go_router/go_router.dart';\r\nimport 'package:image_picker/image_picker.dart';\r\n\r\nimport '../../../auth/bloc/auth_bloc.dart';\r\nimport '../../../auth/bloc/auth_state.dart';\r\nimport '../../../trips/data/models/trip_model.dart';\r\nimport '../../bloc/request_bloc.dart';\r\nimport '../../bloc/request_event.dart';\r\nimport '../../bloc/request_state.dart';\r\nimport '../../data/models/request_model.dart';\r\nimport '../../../matches/bloc/match_bloc.dart';\r\nimport '../../../matches/bloc/match_event.dart';\r\nimport '../../../matches/bloc/match_state.dart';\r\nimport '../widgets/image_picker_grid.dart';\r\n\r\n/// Data class to pass trip info when creating request from a trip\r\nclass CreateRequestFromTrip {\r\n  const CreateRequestFromTrip({\r\n    required this.trip,\r\n  });\r\n\r\n  final TripModel trip;\r\n}\r\n\r\nclass CreateRequestScreen extends StatefulWidget {\r\n  const CreateRequestScreen({super.key, this.existing, this.fromTrip});\r\n\r\n  final RequestModel? existing;\r\n  final CreateRequestFromTrip? fromTrip;\r\n\r\n  @override\r\n  State<CreateRequestScreen> createState() => _CreateRequestScreenState();\r\n}\r\n\r\nclass _CreateRequestScreenState extends State<CreateRequestScreen> {\r\n  final _formKey = GlobalKey<FormState>();\r\n\r\n  // Countries with cities\r\n  static const Map<String, List<String>> _countryCities = {\r\n    'Ethiopia': ['Addis Ababa', 'Adama', 'Bahir Dar', 'Gondar', 'Hawassa', 'Dire Dawa', 'Mekelle', 'Jimma', 'Dessie', 'Harar'],\r\n    'United States': ['New York', 'Los Angeles', 'Washington DC', 'Chicago', 'Houston', 'Miami', 'San Francisco', 'Seattle', 'Boston', 'Atlanta'],\r\n    'United Arab Emirates': ['Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman'],\r\n    'Saudi Arabia': ['Riyadh', 'Jeddah', 'Mecca', 'Medina', 'Dammam'],\r\n    'Qatar': ['Doha', 'Al Wakrah', 'Al Khor'],\r\n    'Kuwait': ['Kuwait City', 'Hawalli', 'Salmiya'],\r\n    'Bahrain': ['Manama', 'Riffa', 'Muharraq'],\r\n    'Oman': ['Muscat', 'Salalah', 'Sohar'],\r\n    'Canada': ['Toronto', 'Vancouver', 'Montreal', 'Calgary', 'Ottawa'],\r\n    'United Kingdom': ['London', 'Manchester', 'Birmingham', 'Liverpool', 'Edinburgh'],\r\n    'Germany': ['Berlin', 'Munich', 'Frankfurt', 'Hamburg', 'Cologne'],\r\n    'France': ['Paris', 'Lyon', 'Marseille', 'Nice', 'Toulouse'],\r\n    'Italy': ['Rome', 'Milan', 'Naples', 'Turin', 'Florence'],\r\n    'Netherlands': ['Amsterdam', 'Rotterdam', 'The Hague', 'Utrecht'],\r\n    'Sweden': ['Stockholm', 'Gothenburg', 'Malmö'],\r\n    'Norway': ['Oslo', 'Bergen', 'Trondheim'],\r\n    'Australia': ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide'],\r\n    'Turkey': ['Istanbul', 'Ankara', 'Izmir', 'Antalya'],\r\n    'South Africa': ['Johannesburg', 'Cape Town', 'Durban', 'Pretoria'],\r\n    'Kenya': ['Nairobi', 'Mombasa', 'Kisumu'],\r\n    'Egypt': ['Cairo', 'Alexandria', 'Giza'],\r\n    'Israel': ['Tel Aviv', 'Jerusalem', 'Haifa'],\r\n    'India': ['Mumbai', 'Delhi', 'Bangalore', 'Chennai', 'Kolkata'],\r\n    'China': ['Beijing', 'Shanghai', 'Guangzhou', 'Shenzhen'],\r\n    'Japan': ['Tokyo', 'Osaka', 'Kyoto', 'Yokohama'],\r\n    'South Korea': ['Seoul', 'Busan', 'Incheon'],\r\n    'Singapore': ['Singapore'],\r\n    'Malaysia': ['Kuala Lumpur', 'Penang', 'Johor Bahru'],\r\n    'Thailand': ['Bangkok', 'Chiang Mai', 'Phuket'],\r\n    'Other': [],\r\n  };\r\n\r\n  // Item details\r\n  final _titleCtrl = TextEditingController();\r\n  final _descriptionCtrl = TextEditingController();\r\n  final _weightCtrl = TextEditingController();\r\n  RequestCategory? _category;\r\n\r\n  // Pickup location\r\n  String? _pickupCountry;\r\n  String? _pickupCity;\r\n  final _pickupCityCtrl = TextEditingController();\r\n  bool _showPickupManualCity = false;\r\n\r\n  // Delivery location\r\n  String? _deliveryCountry;\r\n  String? _deliveryCity;\r\n  final _deliveryCityCtrl = TextEditingController();\r\n  bool _showDeliveryManualCity = false;\r\n\r\n  // Recipient\r\n  final _recipientNameCtrl = TextEditingController();\r\n  final _recipientPhoneCtrl = TextEditingController();\r\n\r\n  bool _autoFilledRecipientForTrip = false;\r\n\r\n  // Optional\r\n  DateTime? _preferredDeliveryDate;\r\n  final _offeredPriceCtrl = TextEditingController();\r\n  bool _isUrgent = false;\r\n\r\n  List<File> _localImages = <File>[];\r\n  List<String> _uploadedUrls = <String>[];\r\n\r\n  bool get _isEdit => widget.existing != null;\r\n  bool get _isFromTrip => widget.fromTrip != null;\r\n  TripModel? get _linkedTrip => widget.fromTrip?.trip;\r\n  List<String> get _countries => _countryCities.keys.toList();\r\n\r\n  List<String> _getCities(String? country) {\r\n    if (country == null || country == 'Other') return [];\r\n    return _countryCities[country] ?? [];\r\n  }\r\n\r\n  @override\r\n  void initState() {\r\n    super.initState();\r\n    final e = widget.existing;\r\n    if (e != null) {\r\n      _titleCtrl.text = e.title;\r\n      _descriptionCtrl.text = e.description;\r\n      _weightCtrl.text = e.weightKg.toStringAsFixed(1);\r\n      _category = e.category;\r\n      _pickupCountry = e.pickupCountry;\r\n      _pickupCity = e.pickupCity;\r\n      _pickupCityCtrl.text = e.pickupCity;\r\n      _deliveryCountry = e.deliveryCountry;\r\n      _deliveryCity = e.deliveryCity;\r\n      _deliveryCityCtrl.text = e.deliveryCity;\r\n      _recipientNameCtrl.text = e.recipientName;\r\n      _recipientPhoneCtrl.text = e.recipientPhone;\r\n      _preferredDeliveryDate = e.preferredDeliveryDate;\r\n      _offeredPriceCtrl.text = e.offeredPrice?.toStringAsFixed(2) ?? '';\r\n      _isUrgent = e.isUrgent;\r\n      _uploadedUrls = List.of(e.imageUrls);\r\n    } else if (_isFromTrip) {\r\n      // Pre-fill from trip data - pickup is trip origin, delivery is trip destination\r\n      final trip = _linkedTrip!;\r\n      _pickupCountry = trip.originCountry;\r\n      _pickupCity = trip.originCity;\r\n      _pickupCityCtrl.text = trip.originCity;\r\n      _deliveryCountry = trip.destinationCountry;\r\n      _deliveryCity = trip.destinationCity;\r\n      _deliveryCityCtrl.text = trip.destinationCity;\r\n    }\r\n  }\r\n\r\n  @override\r\n  void didChangeDependencies() {\r\n    super.didChangeDependencies();\r\n\r\n    // In \"contact traveler\" flow we only ask for item info.\r\n    // Recipient name/phone are auto-filled from the current profile.\r\n    if (_isFromTrip && !_autoFilledRecipientForTrip) {\r\n      final authState = context.read<AuthBloc>().state;\r\n      if (authState is AuthAuthenticated) {\r\n        _recipientNameCtrl.text = authState.user.fullName;\r\n        _recipientPhoneCtrl.text = authState.user.phone?.trim() ?? '';\r\n      }\r\n      _autoFilledRecipientForTrip = true;\r\n    }\r\n  }\r\n\r\n  @override\r\n  void dispose() {\r\n    _titleCtrl.dispose();\r\n    _descriptionCtrl.dispose();\r\n    _weightCtrl.dispose();\r\n    _pickupCityCtrl.dispose();\r\n    _deliveryCityCtrl.dispose();\r\n    _recipientNameCtrl.dispose();\r\n    _recipientPhoneCtrl.dispose();\r\n    _offeredPriceCtrl.dispose();\r\n    super.dispose();\r\n  }\r\n\r\n  Future<void> _pickImages() async {\r\n    final remaining = 5 - (_uploadedUrls.length + _localImages.length);\r\n    if (remaining <= 0) return;\r\n\r\n    final picker = ImagePicker();\r\n    final picks = await picker.pickMultiImage(imageQuality: 85);\r\n    if (picks.isEmpty) return;\r\n\r\n    final next = List<File>.of(_localImages);\r\n    for (final x in picks) {\r\n      if ((_uploadedUrls.length + next.length) >= 5) break;\r\n      next.add(File(x.path));\r\n    }\r\n    setState(() => _localImages = next);\r\n  }\r\n\r\n  Future<void> _pickDate() async {\r\n    final now = DateTime.now();\r\n    final picked = await showDatePicker(\r\n      context: context,\r\n      initialDate: _preferredDeliveryDate ?? now,\r\n      firstDate: now,\r\n      lastDate: DateTime(now.year + 2),\r\n    );\r\n    if (picked != null) setState(() => _preferredDeliveryDate = picked);\r\n  }\r\n\r\n  void _submit(BuildContext blocContext) {\r\n    if (!_formKey.currentState!.validate()) return;\r\n    if (_category == null) {\r\n      ScaffoldMessenger.of(context).showSnackBar(\r\n        const SnackBar(content: Text('Please select a category')),\r\n      );\r\n      return;\r\n    }\r\n\r\n    final pickupCountry = (_pickupCountry ?? '').trim();\r\n    final pickupCity = _pickupCity?.trim() ?? _pickupCityCtrl.text.trim();\r\n    final deliveryCountry = (_deliveryCountry ?? '').trim();\r\n    final deliveryCity = _deliveryCity?.trim() ?? _deliveryCityCtrl.text.trim();\r\n\r\n    if (pickupCountry.isEmpty || pickupCity.isEmpty) {\r\n      ScaffoldMessenger.of(context).showSnackBar(\r\n        const SnackBar(content: Text('Pickup location required')),\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (deliveryCountry.isEmpty || deliveryCity.isEmpty) {\r\n      ScaffoldMessenger.of(context).showSnackBar(\r\n        const SnackBar(content: Text('Delivery location required')),\r\n      );\r\n      return;\r\n    }\r\n\r\n    final authState = context.read<AuthBloc>().state;\r\n    if (authState is! AuthAuthenticated) return;\r\n\r\n    final weight = double.tryParse(_weightCtrl.text.trim()) ?? 0;\r\n    final price = _offeredPriceCtrl.text.trim().isEmpty\r\n        ? null\r\n        : double.tryParse(_offeredPriceCtrl.text.trim());\r\n    final now = DateTime.now();\r\n    final user = authState.user;\r\n\r\n    final recipientName = _isFromTrip ? user.fullName : _recipientNameCtrl.text.trim();\r\n    final recipientPhone = _isFromTrip\r\n      ? ((user.phone?.trim().isNotEmpty ?? false) ? user.phone!.trim() : 'N/A')\r\n      : _recipientPhoneCtrl.text.trim();\r\n\r\n    if (_isEdit) {\r\n      final updated = widget.existing!.copyWith(\r\n        title: _titleCtrl.text.trim(),\r\n        description: _descriptionCtrl.text.trim(),\r\n        category: _category,\r\n        weightKg: weight,\r\n        pickupCity: pickupCity,\r\n        pickupCountry: pickupCountry,\r\n        pickupAddress: pickupCity,\r\n        deliveryCity: deliveryCity,\r\n        deliveryCountry: deliveryCountry,\r\n        deliveryAddress: deliveryCity,\r\n        recipientName: _recipientNameCtrl.text.trim(),\r\n        recipientPhone: _recipientPhoneCtrl.text.trim(),\r\n        preferredDeliveryDate: _preferredDeliveryDate,\r\n        offeredPrice: price,\r\n        isUrgent: _isUrgent,\r\n        imageUrls: _uploadedUrls,\r\n        updatedAt: now,\r\n      );\r\n      blocContext.read<RequestBloc>().add(RequestUpdateRequested(updated));\r\n    } else {\r\n      final request = RequestModel(\r\n        id: '',\r\n        requesterId: user.uid,\r\n        requesterName: user.fullName,\r\n        requesterPhoto: user.photoUrl,\r\n        requesterRating: user.rating,\r\n        title: _titleCtrl.text.trim(),\r\n        description: _descriptionCtrl.text.trim(),\r\n        category: _category!,\r\n        weightKg: weight,\r\n        imageUrls: const [],\r\n        pickupCity: pickupCity,\r\n        pickupCountry: pickupCountry,\r\n        pickupAddress: pickupCity,\r\n        deliveryCity: deliveryCity,\r\n        deliveryCountry: deliveryCountry,\r\n        deliveryAddress: deliveryCity,\r\n        recipientName: recipientName,\r\n        recipientPhone: recipientPhone,\r\n        preferredDeliveryDate: _isFromTrip ? null : _preferredDeliveryDate,\r\n        offeredPrice: price,\r\n        isUrgent: _isUrgent,\r\n        status: RequestStatus.active,\r\n        createdAt: now,\r\n        updatedAt: now,\r\n      );\r\n      blocContext.read<RequestBloc>().add(RequestCreateRequested(request, _localImages));\r\n    }\r\n  }\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    return MultiBlocProvider(\r\n      providers: [\r\n        BlocProvider<RequestBloc>(create: (_) => GetIt.instance<RequestBloc>()),\r\n        BlocProvider<MatchBloc>(create: (_) => GetIt.instance<MatchBloc>()),\r\n      ],\r\n      child: MultiBlocListener(\r\n        listeners: [\r\n          BlocListener<RequestBloc, RequestState>(\r\n            listenWhen: (_, s) => s is RequestCreated || s is RequestUpdated || s is RequestError,\r\n            listener: (context, state) {\r\n              if (state is RequestError) {\r\n                ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(state.message)));\r\n              }\r\n              if (state is RequestCreated) {\r\n                if (_isFromTrip && _linkedTrip != null) {\r\n                  // If from trip, we now proceed to create the match\r\n                  final trip = _linkedTrip!;\r\n                  final authState = context.read<AuthBloc>().state;\r\n                  if (authState is AuthAuthenticated) {\r\n                    final currentUser = authState.user;\r\n                    final itemTitle = _titleCtrl.text.trim();\r\n                    \r\n                    context.read<MatchBloc>().add(\r\n                      MatchCreateRequested(\r\n                        tripId: trip.id,\r\n                        requestId: state.requestId,\r\n                        travelerId: trip.travelerId,\r\n                        travelerName: trip.travelerName,\r\n                        travelerPhoto: trip.travelerPhoto,\r\n                        requesterId: currentUser.uid,\r\n                        requesterName: currentUser.fullName,\r\n                        requesterPhoto: currentUser.photoUrl,\r\n                        itemTitle: itemTitle,\r\n                        route: trip.routeDisplay,\r\n                        tripDate: trip.departureDate,\r\n                      ),\r\n                    );\r\n                  }\r\n                } else {\r\n                  // Normal flow\r\n                  context.pop();\r\n                }\r\n              }\r\n              if (state is RequestUpdated) {\r\n                context.pop();\r\n              }\r\n            },\r\n          ),\r\n          BlocListener<MatchBloc, MatchState>(\r\n            listener: (context, state) {\r\n              if (state is MatchCreated) {\r\n                ScaffoldMessenger.of(context).showSnackBar(\r\n                  const SnackBar(content: Text('Request created and match sent to traveler!')),\r\n                );\r\n                // Return to trip details (or pop twice to go back further? For now just pop)\r\n                context.pop();\r\n              }\r\n              if (state is MatchError) {\r\n                ScaffoldMessenger.of(context).showSnackBar(\r\n                  SnackBar(content: Text('Request created but match failed: ${state.message}')),\r\n                );\r\n                context.pop(); \r\n              }\r\n            },\r\n          ),\r\n        ],\r\n        child: BlocBuilder<RequestBloc, RequestState>(\r\n        builder: (context, state) {\r\n          final submitting = state is RequestCreating;\r\n          final progress = state is RequestCreating ? state.uploadProgress : null;\r\n\r\n          return Scaffold(\r\n            appBar: AppBar(\r\n              title: Text(\r\n                _isEdit\r\n                    ? 'Edit Request'\r\n                    : (_isFromTrip ? 'Contact Traveler' : 'Send Item'),\r\n              ),\r\n            ),\r\n            body: Column(\r\n              children: [\r\n                if (submitting && progress != null)\r\n                  LinearProgressIndicator(value: progress == 0 ? null : progress),\r\n                Expanded(\r\n                  child: Form(\r\n                    key: _formKey,\r\n                    child: ListView(\r\n                      padding: const EdgeInsets.all(16),\r\n                      children: [\r\n                        if (_isFromTrip) ...[\r\n                          Container(\r\n                            padding: const EdgeInsets.all(12),\r\n                            decoration: BoxDecoration(\r\n                                color: Theme.of(context).colorScheme.primaryContainer.withOpacity(0.3),\r\n                                borderRadius: BorderRadius.circular(8),\r\n                                border: Border.all(color: Theme.of(context).colorScheme.primary.withOpacity(0.3))\r\n                            ),\r\n                            child: Row(\r\n                              children: [\r\n                                const Icon(Icons.info_outline, size: 20),\r\n                                const SizedBox(width: 8),\r\n                                Expanded(child: Text(\r\n                                  'Only item info is required. Pickup and delivery cities are taken from the selected trip.',\r\n                                  style: Theme.of(context).textTheme.bodySmall,\r\n                                )),\r\n                              ],\r\n                            ),\r\n                          ),\r\n                          const SizedBox(height: 16),\r\n                        ],\r\n\r\n                        // Item details\r\n                        Text('What are you sending?', style: Theme.of(context).textTheme.titleMedium),\r\n                        const SizedBox(height: 12),\r\n                        TextFormField(\r\n                          controller: _titleCtrl,\r\n                          decoration: const InputDecoration(\r\n                            labelText: 'Item name *',\r\n                            hintText: 'e.g., iPhone charger, Documents',\r\n                            border: OutlineInputBorder(),\r\n                          ),\r\n                          validator: (v) => v?.trim().isEmpty == true ? 'Required' : null,\r\n                        ),\r\n                        const SizedBox(height: 12),\r\n                        Row(\r\n                          children: [\r\n                            Expanded(\r\n                              child: DropdownButtonFormField<RequestCategory>(\r\n                                value: _category,\r\n                                decoration: const InputDecoration(\r\n                                  labelText: 'Category *',\r\n                                  border: OutlineInputBorder(),\r\n                                ),\r\n                                items: RequestCategory.values.map((c) => DropdownMenuItem(\r\n                                  value: c,\r\n                                  child: Text(_categoryLabel(c)),\r\n                                )).toList(),\r\n                                onChanged: submitting ? null : (v) => setState(() => _category = v),\r\n                              ),\r\n                            ),\r\n                            const SizedBox(width: 12),\r\n                            SizedBox(\r\n                              width: 100,\r\n                              child: TextFormField(\r\n                                controller: _weightCtrl,\r\n                                keyboardType: TextInputType.number,\r\n                                decoration: const InputDecoration(\r\n                                  labelText: 'Weight *',\r\n                                  suffixText: 'kg',\r\n                                  border: OutlineInputBorder(),\r\n                                ),\r\n                                validator: (v) {\r\n                                  final x = double.tryParse(v?.trim() ?? '');\r\n                                  return (x == null || x <= 0) ? 'Invalid' : null;\r\n                                },\r\n                              ),\r\n                            ),\r\n                          ],\r\n                        ),\r\n                        const SizedBox(height: 20),\r\n\r\n                        // Pickup location - hidden when from trip\r\n                        if (!_isFromTrip) ...[\r\n                          Text('Pickup Location', style: Theme.of(context).textTheme.titleMedium),\r\n                          const SizedBox(height: 12),\r\n                          _buildLocationSection(\r\n                            isPickup: true,\r\n                            enabled: !submitting,\r\n                          ),\r\n                          const SizedBox(height: 20),\r\n\r\n                          // Delivery location\r\n                          Text('Delivery Location', style: Theme.of(context).textTheme.titleMedium),\r\n                          const SizedBox(height: 12),\r\n                          _buildLocationSection(\r\n                            isPickup: false,\r\n                            enabled: !submitting,\r\n                          ),\r\n                          const SizedBox(height: 20),\r\n                        ],\r\n\r\n                        // Recipient - only required for full \"Send Item\" flow\r\n                        if (!_isFromTrip) ...[\r\n                          Text('Recipient', style: Theme.of(context).textTheme.titleMedium),\r\n                          const SizedBox(height: 12),\r\n                          Row(\r\n                            children: [\r\n                              Expanded(\r\n                                child: TextFormField(\r\n                                  controller: _recipientNameCtrl,\r\n                                  decoration: const InputDecoration(\r\n                                    labelText: 'Name *',\r\n                                    border: OutlineInputBorder(),\r\n                                  ),\r\n                                  validator: (v) => v?.trim().isEmpty == true ? 'Required' : null,\r\n                                ),\r\n                              ),\r\n                              const SizedBox(width: 12),\r\n                              Expanded(\r\n                                child: TextFormField(\r\n                                  controller: _recipientPhoneCtrl,\r\n                                  keyboardType: TextInputType.phone,\r\n                                  decoration: const InputDecoration(\r\n                                    labelText: 'Phone *',\r\n                                    border: OutlineInputBorder(),\r\n                                  ),\r\n                                  validator: (v) => v?.trim().isEmpty == true ? 'Required' : null,\r\n                                ),\r\n                              ),\r\n                            ],\r\n                          ),\r\n                          const SizedBox(height: 20),\r\n                        ],\r\n\r\n                        // Optional section - description always visible\r\n                        Text(_isFromTrip ? 'Additional Info' : 'Optional', style: Theme.of(context).textTheme.titleMedium),\r\n                        const SizedBox(height: 12),\r\n                        TextFormField(\r\n                          controller: _descriptionCtrl,\r\n                          maxLines: 2,\r\n                          decoration: const InputDecoration(\r\n                            labelText: 'Description / Notes',\r\n                            border: OutlineInputBorder(),\r\n                          ),\r\n                        ),\r\n                        // Date and price - hidden when from trip\r\n                        if (!_isFromTrip) ...[\r\n                          const SizedBox(height: 12),\r\n                          Row(\r\n                            children: [\r\n                              Expanded(\r\n                                child: OutlinedButton.icon(\r\n                                  onPressed: submitting ? null : _pickDate,\r\n                                  icon: const Icon(Icons.calendar_today, size: 18),\r\n                                  label: Text(_preferredDeliveryDate == null\r\n                                      ? 'Delivery date'\r\n                                      : '${_preferredDeliveryDate!.day}/${_preferredDeliveryDate!.month}'),\r\n                                ),\r\n                              ),\r\n                              const SizedBox(width: 12),\r\n                              SizedBox(\r\n                                width: 120,\r\n                                child: TextFormField(\r\n                                  controller: _offeredPriceCtrl,\r\n                                  keyboardType: TextInputType.number,\r\n                                  decoration: const InputDecoration(\r\n                                    labelText: 'Price \\$',\r\n                                    border: OutlineInputBorder(),\r\n                                  ),\r\n                                ),\r\n                              ),\r\n                            ],\r\n                          ),\r\n                        ],\r\n                        const SizedBox(height: 8),\r\n                        SwitchListTile(\r\n                          value: _isUrgent,\r\n                          onChanged: submitting ? null : (v) => setState(() => _isUrgent = v),\r\n                          title: const Text('Urgent delivery'),\r\n                          contentPadding: EdgeInsets.zero,\r\n                        ),\r\n                        const SizedBox(height: 12),\r\n\r\n                        // Photos\r\n                        ImagePickerGrid(\r\n                          uploadedUrls: _uploadedUrls,\r\n                          localFiles: _localImages,\r\n                          onImagesChanged: (files) => setState(() => _localImages = files),\r\n                          onRemoveUrl: (url) => setState(() => _uploadedUrls.remove(url)),\r\n                        ),\r\n                        if (_localImages.length + _uploadedUrls.length < 5)\r\n                          TextButton.icon(\r\n                            onPressed: submitting ? null : _pickImages,\r\n                            icon: const Icon(Icons.add_photo_alternate),\r\n                            label: const Text('Add photos'),\r\n                          ),\r\n                        const SizedBox(height: 24),\r\n\r\n                        BlocBuilder<MatchBloc, MatchState>(\r\n                          builder: (context, matchState) {\r\n                             final matchLoading = matchState is MatchCreating;\r\n                             return FilledButton.icon(\r\n                              onPressed: (submitting || matchLoading) ? null : () => _submit(context),\r\n                              icon: const Icon(Icons.send),\r\n                              label: Text(\r\n                                _isEdit\r\n                                    ? 'Save Changes'\r\n                                    : (_isFromTrip\r\n                                        ? (matchLoading ? 'Sending...' : 'Send to Traveler')\r\n                                        : 'Create Request'),\r\n                              ),\r\n                            ); \r\n                          }\r\n                        ),\r\n                      ],\r\n                    ),\r\n                  ),\r\n                ),\r\n              ],\r\n            ),\r\n          );\r\n        },\r\n      ),\r\n    ),\r\n    );\r\n  }\r\n\r\n  Widget _buildLockedLocation(String? city, String? country) {\r\n    return TextFormField(\r\n      initialValue: '$city, $country',\r\n      readOnly: true,\r\n      enabled: false,\r\n      decoration: const InputDecoration(\r\n        border: OutlineInputBorder(),\r\n        filled: true,\r\n      ),\r\n    );\r\n  }\r\n\r\n  Widget _buildLockedDate() {\r\n    final d = _preferredDeliveryDate;\r\n    final text = d != null ? '${d.day}/${d.month}/${d.year}' : 'Any';\r\n    return TextFormField(\r\n      initialValue: text,\r\n      readOnly: true,\r\n      enabled: false,\r\n      decoration: const InputDecoration(\r\n        labelText: 'Date (Matched to Trip)',\r\n        border: OutlineInputBorder(),\r\n        filled: true,\r\n        prefixIcon: Icon(Icons.calendar_today),\r\n      ),\r\n    );\r\n  }\r\n\r\n  Widget _buildLocationSection({required bool isPickup, required bool enabled}) {\r\n    final country = isPickup ? _pickupCountry : _deliveryCountry;\r\n    final city = isPickup ? _pickupCity : _deliveryCity;\r\n    final cityCtrl = isPickup ? _pickupCityCtrl : _deliveryCityCtrl;\r\n    final showManualInput = isPickup ? _showPickupManualCity : _showDeliveryManualCity;\r\n    final cities = _getCities(country);\r\n\r\n    return Column(\r\n      children: [\r\n        DropdownButtonFormField<String>(\r\n          value: country != null && _countries.contains(country) ? country : null,\r\n          decoration: const InputDecoration(\r\n            labelText: 'Country *',\r\n            border: OutlineInputBorder(),\r\n          ),\r\n          items: _countries.map((c) => DropdownMenuItem(value: c, child: Text(c))).toList(),\r\n          onChanged: enabled ? (v) {\r\n            setState(() {\r\n              if (isPickup) {\r\n                _pickupCountry = v;\r\n                _pickupCity = null;\r\n                _pickupCityCtrl.clear();\r\n                _showPickupManualCity = false;\r\n              } else {\r\n                _deliveryCountry = v;\r\n                _deliveryCity = null;\r\n                _deliveryCityCtrl.clear();\r\n                _showDeliveryManualCity = false;\r\n              }\r\n            });\r\n          } : null,\r\n        ),\r\n        const SizedBox(height: 12),\r\n\r\n        if (cities.isNotEmpty && !showManualInput)\r\n          DropdownButtonFormField<String>(\r\n            value: city != null && cities.contains(city) ? city : null,\r\n            decoration: const InputDecoration(\r\n              labelText: 'City *',\r\n              border: OutlineInputBorder(),\r\n            ),\r\n            items: [\r\n              ...cities.map((c) => DropdownMenuItem(value: c, child: Text(c))),\r\n              const DropdownMenuItem(value: '__other__', child: Text('Other (enter manually)')),\r\n            ],\r\n            onChanged: enabled ? (v) {\r\n              setState(() {\r\n                if (v == '__other__') {\r\n                  if (isPickup) {\r\n                    _pickupCity = null;\r\n                    _pickupCityCtrl.clear();\r\n                    _showPickupManualCity = true;\r\n                  } else {\r\n                    _deliveryCity = null;\r\n                    _deliveryCityCtrl.clear();\r\n                    _showDeliveryManualCity = true;\r\n                  }\r\n                } else {\r\n                  if (isPickup) {\r\n                    _pickupCity = v;\r\n                    _pickupCityCtrl.text = v ?? '';\r\n                  } else {\r\n                    _deliveryCity = v;\r\n                    _deliveryCityCtrl.text = v ?? '';\r\n                  }\r\n                }\r\n              });\r\n            } : null,\r\n          ),\r\n\r\n        // Show manual input when \"Other\" selected or country has no cities\r\n        if (showManualInput || country == 'Other' || (country != null && cities.isEmpty))\r\n          Column(\r\n            children: [\r\n              TextFormField(\r\n                controller: cityCtrl,\r\n                enabled: enabled,\r\n                decoration: const InputDecoration(\r\n                  labelText: 'City *',\r\n                  hintText: 'Enter city name',\r\n                  border: OutlineInputBorder(),\r\n                ),\r\n                validator: (v) => v?.trim().isEmpty == true ? 'Required' : null,\r\n              ),\r\n              if (showManualInput && cities.isNotEmpty)\r\n                Align(\r\n                  alignment: Alignment.centerLeft,\r\n                  child: TextButton.icon(\r\n                    onPressed: enabled ? () {\r\n                      setState(() {\r\n                        if (isPickup) {\r\n                          _showPickupManualCity = false;\r\n                          _pickupCityCtrl.clear();\r\n                        } else {\r\n                          _showDeliveryManualCity = false;\r\n                          _deliveryCityCtrl.clear();\r\n                        }\r\n                      });\r\n                    } : null,\r\n                    icon: const Icon(Icons.arrow_back, size: 16),\r\n                    label: const Text('Back to city list'),\r\n                  ),\r\n                ),\r\n            ],\r\n          ),\r\n      ],\r\n    );\r\n  }\r\n\r\n  String _categoryLabel(RequestCategory c) => switch (c) {\r\n    RequestCategory.documents => 'Documents',\r\n    RequestCategory.electronics => 'Electronics',\r\n    RequestCategory.clothing => 'Clothing',\r\n    RequestCategory.food => 'Food',\r\n    RequestCategory.medicine => 'Medicine',\r\n    RequestCategory.other => 'Other',\r\n  };\r\n}\r\n"
        }
    ]
}