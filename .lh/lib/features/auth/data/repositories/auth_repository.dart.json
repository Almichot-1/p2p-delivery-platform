{
    "sourceFile": "lib/features/auth/data/repositories/auth_repository.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768062489429,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768062489429,
            "name": "Commit-0",
            "content": "import 'dart:async';\r\n\r\nimport 'package:cloud_firestore/cloud_firestore.dart';\r\nimport 'package:firebase_auth/firebase_auth.dart';\r\nimport 'package:google_sign_in/google_sign_in.dart';\r\n\r\nimport '../../../../core/services/firebase_service.dart';\r\nimport '../models/user_model.dart';\r\n\r\nclass AuthRepository {\r\n  AuthRepository({required FirebaseService firebaseService})\r\n      : _firebaseService = firebaseService {\r\n    _authStateSub = authStateChanges.listen((user) {\r\n      _subscribeToCurrentUserProfile(user);\r\n    });\r\n  }\r\n\r\n  final FirebaseService _firebaseService;\r\n\r\n  final StreamController<UserModel?> _profileController =\r\n      StreamController<UserModel?>.broadcast();\r\n\r\n  StreamSubscription<User?>? _authStateSub;\r\n  StreamSubscription<DocumentSnapshot<Map<String, dynamic>>>? _profileSub;\r\n\r\n  Stream<User?> get authStateChanges {\r\n    try {\r\n      return _firebaseService.auth.authStateChanges();\r\n    } catch (_) {\r\n      // Allows app/tests to boot without Firebase native config.\r\n      return Stream<User?>.value(null);\r\n    }\r\n  }\r\n\r\n  Stream<UserModel?> get userProfileStream => _profileController.stream;\r\n\r\n  User? getCurrentUser() {\r\n    try {\r\n      return _firebaseService.auth.currentUser;\r\n    } catch (_) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  Future<UserModel?> getUserById(String uid) async {\r\n    final doc = await _firebaseService.users.doc(uid).get();\r\n    if (!doc.exists) return null;\r\n    return UserModel.fromFirestore(doc);\r\n  }\r\n\r\n  Future<UserModel> registerWithEmail(\r\n    String email,\r\n    String password,\r\n    String fullName,\r\n    String? phone,\r\n  ) async {\r\n    try {\r\n      final cred = await _firebaseService.auth.createUserWithEmailAndPassword(\r\n        email: email.trim(),\r\n        password: password,\r\n      );\r\n\r\n      final user = cred.user;\r\n      if (user == null) {\r\n        throw Exception('Registration failed: user is null');\r\n      }\r\n\r\n      final data = <String, dynamic>{\r\n        'uid': user.uid,\r\n        'email': user.email ?? email.trim(),\r\n        'phone': phone,\r\n        'fullName': fullName.trim(),\r\n        'photoUrl': null,\r\n        'role': UserRole.requester.name,\r\n        'verified': false,\r\n        'rating': 0.0,\r\n        'totalReviews': 0,\r\n        'completedDeliveries': 0,\r\n        'createdAt': FieldValue.serverTimestamp(),\r\n        'lastActiveAt': FieldValue.serverTimestamp(),\r\n      }..removeWhere((key, value) => value == null);\r\n\r\n      await _firebaseService.users\r\n          .doc(user.uid)\r\n          .set(data, SetOptions(merge: true));\r\n\r\n      final model = await getUserById(user.uid);\r\n      if (model == null) {\r\n        throw Exception('Registration succeeded but profile missing');\r\n      }\r\n\r\n      return model;\r\n    } on FirebaseAuthException catch (e) {\r\n      throw Exception(_friendlyAuthError(e));\r\n    }\r\n  }\r\n\r\n  Future<UserModel> loginWithEmail(String email, String password) async {\r\n    try {\r\n      final cred = await _firebaseService.auth.signInWithEmailAndPassword(\r\n        email: email.trim(),\r\n        password: password,\r\n      );\r\n\r\n      final user = cred.user;\r\n      if (user == null) {\r\n        throw Exception('Login failed: user is null');\r\n      }\r\n\r\n      await _firebaseService.users.doc(user.uid).set(\r\n        <String, dynamic>{\r\n          'lastActiveAt': FieldValue.serverTimestamp(),\r\n        },\r\n        SetOptions(merge: true),\r\n      );\r\n\r\n      final model = await getUserById(user.uid);\r\n      if (model == null) {\r\n        throw Exception('No user profile found for this account');\r\n      }\r\n\r\n      return model;\r\n    } on FirebaseAuthException catch (e) {\r\n      throw Exception(_friendlyAuthError(e));\r\n    }\r\n  }\r\n\r\n  Future<void> sendPasswordResetEmail(String email) async {\r\n    try {\r\n      await _firebaseService.auth.sendPasswordResetEmail(email: email.trim());\r\n    } on FirebaseAuthException catch (e) {\r\n      throw Exception(_friendlyAuthError(e));\r\n    }\r\n  }\r\n\r\n  Future<UserModel> signInWithGoogle() async {\r\n    try {\r\n      final googleSignIn = GoogleSignIn(scopes: const ['email']);\r\n      final account = await googleSignIn.signIn();\r\n      if (account == null) {\r\n        throw Exception('Google sign-in cancelled');\r\n      }\r\n\r\n      final auth = await account.authentication;\r\n      final credential = GoogleAuthProvider.credential(\r\n        accessToken: auth.accessToken,\r\n        idToken: auth.idToken,\r\n      );\r\n\r\n      final cred = await _firebaseService.auth.signInWithCredential(credential);\r\n      final user = cred.user;\r\n      if (user == null) {\r\n        throw Exception('Google sign-in failed: user is null');\r\n      }\r\n\r\n      // Ensure profile exists.\r\n      final displayName = (user.displayName ?? '').trim();\r\n      final email = (user.email ?? '').trim();\r\n      final fallbackName = email.isNotEmpty ? email.split('@').first : 'User';\r\n\r\n      final data = <String, dynamic>{\r\n        'uid': user.uid,\r\n        'email': email.isNotEmpty ? email : null,\r\n        'phone': (user.phoneNumber ?? '').trim().isEmpty ? null : user.phoneNumber,\r\n        'fullName': displayName.isNotEmpty ? displayName : fallbackName,\r\n        'photoUrl': (user.photoURL ?? '').trim().isEmpty ? null : user.photoURL,\r\n        'role': UserRole.requester.name,\r\n        'verified': false,\r\n        'rating': 0.0,\r\n        'totalReviews': 0,\r\n        'completedDeliveries': 0,\r\n        'createdAt': FieldValue.serverTimestamp(),\r\n        'lastActiveAt': FieldValue.serverTimestamp(),\r\n      }..removeWhere((key, value) => value == null);\r\n\r\n      await _firebaseService.users.doc(user.uid).set(\r\n            data,\r\n            SetOptions(merge: true),\r\n          );\r\n\r\n      final model = await getUserById(user.uid);\r\n      if (model == null) {\r\n        throw Exception('Google sign-in succeeded but profile missing');\r\n      }\r\n      return model;\r\n    } on FirebaseAuthException catch (e) {\r\n      throw Exception(_friendlyAuthError(e));\r\n    } on Exception {\r\n      rethrow;\r\n    } catch (e) {\r\n      throw Exception(e.toString());\r\n    }\r\n  }\r\n\r\n  Future<void> logout() async {\r\n    await _cancelProfileSubscription();\r\n    try {\r\n      await _firebaseService.auth.signOut();\r\n    } catch (_) {\r\n      // no-op\r\n    }\r\n    _profileController.add(null);\r\n  }\r\n\r\n  Future<void> dispose() async {\r\n    await _cancelProfileSubscription();\r\n    await _authStateSub?.cancel();\r\n    await _profileController.close();\r\n  }\r\n\r\n  void _subscribeToCurrentUserProfile(User? user) {\r\n    _profileSub?.cancel();\r\n    _profileSub = null;\r\n\r\n    if (user == null) {\r\n      _profileController.add(null);\r\n      return;\r\n    }\r\n\r\n    _profileSub = _firebaseService.users.doc(user.uid).snapshots().listen(\r\n      (doc) {\r\n        if (!doc.exists) {\r\n          _profileController.add(null);\r\n          return;\r\n        }\r\n        _profileController.add(UserModel.fromFirestore(doc));\r\n      },\r\n      onError: (_) {\r\n        _profileController.add(null);\r\n      },\r\n    );\r\n  }\r\n\r\n  Future<void> _cancelProfileSubscription() async {\r\n    await _profileSub?.cancel();\r\n    _profileSub = null;\r\n  }\r\n\r\n  String _friendlyAuthError(FirebaseAuthException e) {\r\n    final msg = (e.message ?? '').toUpperCase();\r\n    if (msg.contains('CONFIGURATION_NOT_FOUND')) {\r\n      return 'Firebase Auth is not fully configured for this Android build. Add your debug SHA-1/SHA-256 fingerprints in Firebase Console, then re-download android/app/google-services.json and rebuild.';\r\n    }\r\n\r\n    switch (e.code) {\r\n      case 'invalid-email':\r\n        return 'Please enter a valid email address.';\r\n      case 'user-not-found':\r\n        return 'No account found for that email.';\r\n      case 'wrong-password':\r\n        return 'Incorrect password.';\r\n      case 'email-already-in-use':\r\n        return 'That email is already registered.';\r\n      case 'weak-password':\r\n        return 'Password is too weak (minimum 6 characters).';\r\n      case 'too-many-requests':\r\n        return 'Too many attempts. Please try again later.';\r\n      case 'network-request-failed':\r\n        return 'Network error. Please check your connection.';\r\n      default:\r\n        return e.message ?? 'Authentication error. Please try again.';\r\n    }\r\n  }\r\n}\r\n"
        }
    ]
}