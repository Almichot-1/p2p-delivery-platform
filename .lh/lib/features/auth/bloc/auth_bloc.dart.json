{
    "sourceFile": "lib/features/auth/bloc/auth_bloc.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768062457760,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768062457760,
            "name": "Commit-0",
            "content": "import 'dart:async';\r\n\r\nimport 'package:flutter_bloc/flutter_bloc.dart';\r\n\r\nimport '../data/models/user_model.dart';\r\nimport '../data/repositories/auth_repository.dart';\r\nimport 'auth_event.dart';\r\nimport 'auth_state.dart';\r\n\r\nclass AuthBloc extends Bloc<AuthEvent, AuthState> {\r\n  AuthBloc({required AuthRepository authRepository})\r\n      : _authRepository = authRepository,\r\n        super(const AuthInitial()) {\r\n    on<AuthCheckRequested>(_onCheckRequested);\r\n    on<AuthLoginRequested>(_onLoginRequested);\r\n    on<AuthRegisterRequested>(_onRegisterRequested);\r\n    on<AuthGoogleSignInRequested>(_onGoogleSignInRequested);\r\n    on<AuthLogoutRequested>(_onLogoutRequested);\r\n    on<AuthForgotPasswordRequested>(_onForgotPasswordRequested);\r\n\r\n    _profileSub = _authRepository.userProfileStream.listen((profile) {\r\n      final authUser = _authRepository.getCurrentUser();\r\n\r\n      if (authUser == null || profile == null) {\r\n        add(const AuthCheckRequested());\r\n        return;\r\n      }\r\n\r\n      add(_ProfileUpdated(profile));\r\n    });\r\n\r\n    on<_ProfileUpdated>(_onProfileUpdated);\r\n  }\r\n\r\n  final AuthRepository _authRepository;\r\n  StreamSubscription<UserModel?>? _profileSub;\r\n\r\n  Future<void> _onCheckRequested(\r\n    AuthCheckRequested event,\r\n    Emitter<AuthState> emit,\r\n  ) async {\r\n    final user = _authRepository.getCurrentUser();\r\n    if (user == null) {\r\n      emit(const AuthUnauthenticated());\r\n      return;\r\n    }\r\n\r\n    try {\r\n      final profile = await _authRepository.getUserById(user.uid);\r\n      if (profile == null) {\r\n        await _authRepository.logout();\r\n        emit(const AuthUnauthenticated());\r\n        return;\r\n      }\r\n      emit(AuthAuthenticated(profile));\r\n    } catch (e) {\r\n      emit(AuthError(e.toString().replaceFirst('Exception: ', '')));\r\n    }\r\n  }\r\n\r\n  Future<void> _onLoginRequested(\r\n    AuthLoginRequested event,\r\n    Emitter<AuthState> emit,\r\n  ) async {\r\n    emit(const AuthLoading());\r\n    try {\r\n      final user = await _authRepository.loginWithEmail(event.email, event.password);\r\n      emit(AuthAuthenticated(user));\r\n    } catch (e) {\r\n      emit(AuthError(e.toString().replaceFirst('Exception: ', '')));\r\n      emit(const AuthUnauthenticated());\r\n    }\r\n  }\r\n\r\n  Future<void> _onRegisterRequested(\r\n    AuthRegisterRequested event,\r\n    Emitter<AuthState> emit,\r\n  ) async {\r\n    emit(const AuthLoading());\r\n    try {\r\n      final user = await _authRepository.registerWithEmail(\r\n        event.email,\r\n        event.password,\r\n        event.fullName,\r\n        event.phone,\r\n      );\r\n      emit(AuthAuthenticated(user));\r\n    } catch (e) {\r\n      emit(AuthError(e.toString().replaceFirst('Exception: ', '')));\r\n      emit(const AuthUnauthenticated());\r\n    }\r\n  }\r\n\r\n  Future<void> _onGoogleSignInRequested(\r\n    AuthGoogleSignInRequested event,\r\n    Emitter<AuthState> emit,\r\n  ) async {\r\n    emit(const AuthLoading());\r\n    try {\r\n      final user = await _authRepository.signInWithGoogle();\r\n      emit(AuthAuthenticated(user));\r\n    } catch (e) {\r\n      emit(AuthError(e.toString().replaceFirst('Exception: ', '')));\r\n      emit(const AuthUnauthenticated());\r\n    }\r\n  }\r\n\r\n  Future<void> _onLogoutRequested(\r\n    AuthLogoutRequested event,\r\n    Emitter<AuthState> emit,\r\n  ) async {\r\n    emit(const AuthLoading());\r\n    await _authRepository.logout();\r\n    await _profileSub?.cancel();\r\n    _profileSub = null;\r\n    emit(const AuthUnauthenticated());\r\n  }\r\n\r\n  Future<void> _onForgotPasswordRequested(\r\n    AuthForgotPasswordRequested event,\r\n    Emitter<AuthState> emit,\r\n  ) async {\r\n    emit(const AuthLoading());\r\n    try {\r\n      await _authRepository.sendPasswordResetEmail(event.email);\r\n      emit(AuthPasswordResetSent(event.email));\r\n      emit(const AuthUnauthenticated());\r\n    } catch (e) {\r\n      emit(AuthError(e.toString().replaceFirst('Exception: ', '')));\r\n      emit(const AuthUnauthenticated());\r\n    }\r\n  }\r\n\r\n  void _onProfileUpdated(_ProfileUpdated event, Emitter<AuthState> emit) {\r\n    emit(AuthAuthenticated(event.user));\r\n  }\r\n\r\n  @override\r\n  Future<void> close() async {\r\n    await _profileSub?.cancel();\r\n    return super.close();\r\n  }\r\n}\r\n\r\nclass _ProfileUpdated extends AuthEvent {\r\n  const _ProfileUpdated(this.user);\r\n\r\n  final UserModel user;\r\n\r\n  @override\r\n  List<Object?> get props => <Object?>[user];\r\n}\r\n"
        }
    ]
}