{
    "sourceFile": "lib/features/trips/presentation/screens/trips_list_screen.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768064762786,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768064762786,
            "name": "Commit-0",
            "content": "import 'package:flutter/material.dart';\r\nimport 'package:flutter_bloc/flutter_bloc.dart';\r\nimport 'package:get_it/get_it.dart';\r\nimport 'package:go_router/go_router.dart';\r\n\r\nimport '../../../../config/routes.dart';\r\nimport '../../bloc/trip_bloc.dart';\r\nimport '../../bloc/trip_event.dart';\r\nimport '../../bloc/trip_state.dart';\r\nimport '../../data/models/trip_model.dart';\r\nimport '../widgets/trip_card.dart';\r\nimport '../widgets/trip_filter.dart';\r\n\r\nclass TripsListScreen extends StatefulWidget {\r\n  const TripsListScreen({super.key});\r\n\r\n  @override\r\n  State<TripsListScreen> createState() => _TripsListScreenState();\r\n}\r\n\r\nclass _TripsListScreenState extends State<TripsListScreen> {\r\n  TripFilters _filters = const TripFilters();\r\n\r\n  DateTime? _effectiveAfterDate(TripFilters f) {\r\n    if (f.includePast) return f.afterDate;\r\n\r\n    final now = DateTime.now();\r\n    final today = DateTime(now.year, now.month, now.day);\r\n\r\n    final picked = f.afterDate;\r\n    if (picked == null) return today;\r\n    return picked.isAfter(today) ? picked : today;\r\n  }\r\n\r\n  void _load(BuildContext blocContext) {\r\n    blocContext.read<TripBloc>().add(\r\n          TripsLoadRequested(\r\n            destination: _filters.destinationCountry,\r\n            afterDate: _effectiveAfterDate(_filters),\r\n          ),\r\n        );\r\n  }\r\n\r\n  Future<void> _refresh(BuildContext blocContext) async {\r\n    _load(blocContext);\r\n    await Future<void>.delayed(const Duration(milliseconds: 250));\r\n  }\r\n\r\n  void _openFilter(BuildContext blocContext) {\r\n    showModalBottomSheet<void>(\r\n      context: blocContext,\r\n      isScrollControlled: true,\r\n      builder: (context) {\r\n        return TripFilterSheet(\r\n          initial: _filters,\r\n          onApply: (f) {\r\n            setState(() => _filters = f);\r\n            _load(blocContext);\r\n          },\r\n        );\r\n      },\r\n    );\r\n  }\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    return BlocProvider<TripBloc>(\r\n      create: (_) => GetIt.instance<TripBloc>()\r\n        ..add(\r\n          TripsLoadRequested(\r\n            destination: _filters.destinationCountry,\r\n            afterDate: _effectiveAfterDate(_filters),\r\n          ),\r\n        ),\r\n      child: BlocConsumer<TripBloc, TripState>(\r\n        listenWhen: (_, s) => s is TripError,\r\n        listener: (context, state) {\r\n          if (state is TripError) {\r\n            ScaffoldMessenger.of(context).showSnackBar(\r\n              SnackBar(content: Text(state.message)),\r\n            );\r\n          }\r\n        },\r\n        builder: (context, state) {\r\n          final trips = state is TripsLoaded ? state.trips : const <TripModel>[];\r\n\r\n          return Scaffold(\r\n            appBar: AppBar(\r\n              title: const Text('Available Trips'),\r\n              actions: [\r\n                IconButton(\r\n                  icon: const Icon(Icons.tune),\r\n                  tooltip: 'Filter',\r\n                  onPressed: () => _openFilter(context),\r\n                ),\r\n              ],\r\n            ),\r\n            body: Column(\r\n              children: [\r\n                if (!_filters.isEmpty)\r\n                  Padding(\r\n                    padding: const EdgeInsets.fromLTRB(16, 12, 16, 0),\r\n                    child: Align(\r\n                      alignment: Alignment.centerLeft,\r\n                      child: Wrap(\r\n                        spacing: 8,\r\n                        runSpacing: 8,\r\n                        children: [\r\n                          if (_filters.destinationCountry != null &&\r\n                              _filters.destinationCountry!.trim().isNotEmpty)\r\n                            InputChip(\r\n                              label: Text('Country: ${_filters.destinationCountry}'),\r\n                              onDeleted: () {\r\n                                setState(() {\r\n                                  _filters = TripFilters(\r\n                                    destinationCountry: null,\r\n                                    afterDate: _filters.afterDate,\r\n                                    includePast: _filters.includePast,\r\n                                  );\r\n                                });\r\n                                _load(context);\r\n                              },\r\n                            ),\r\n                          if (_filters.afterDate != null)\r\n                            InputChip(\r\n                              label: Text(\r\n                                'After: ${_filters.afterDate!.toLocal().toString().split(' ').first}',\r\n                              ),\r\n                              onDeleted: () {\r\n                                setState(() {\r\n                                  _filters = TripFilters(\r\n                                    destinationCountry: _filters.destinationCountry,\r\n                                    afterDate: null,\r\n                                    includePast: _filters.includePast,\r\n                                  );\r\n                                });\r\n                                _load(context);\r\n                              },\r\n                            ),\r\n                          if (_filters.includePast)\r\n                            InputChip(\r\n                              label: const Text('Including past trips'),\r\n                              onDeleted: () {\r\n                                setState(() {\r\n                                  _filters = TripFilters(\r\n                                    destinationCountry: _filters.destinationCountry,\r\n                                    afterDate: _filters.afterDate,\r\n                                    includePast: false,\r\n                                  );\r\n                                });\r\n                                _load(context);\r\n                              },\r\n                            ),\r\n                        ],\r\n                      ),\r\n                    ),\r\n                  ),\r\n                Expanded(\r\n                  child: RefreshIndicator(\r\n                    onRefresh: () => _refresh(context),\r\n                    child: switch (state) {\r\n                      TripLoading() => const Center(child: CircularProgressIndicator()),\r\n                      TripsLoaded() => trips.isEmpty\r\n                          ? ListView(\r\n                              children: const [\r\n                                SizedBox(height: 120),\r\n                                Center(child: Text('No trips found.')),\r\n                              ],\r\n                            )\r\n                          : ListView.separated(\r\n                              padding: const EdgeInsets.all(16),\r\n                              itemCount: trips.length,\r\n                              separatorBuilder: (_, __) => const SizedBox(height: 12),\r\n                              itemBuilder: (context, i) {\r\n                                final t = trips[i];\r\n                                return TripCard(\r\n                                  trip: t,\r\n                                  onTap: () => context.push('${RoutePaths.trips}/${t.id}'),\r\n                                );\r\n                              },\r\n                            ),\r\n                      TripError() => ListView(\r\n                          children: [\r\n                            const SizedBox(height: 120),\r\n                            Center(child: Text(state.message)),\r\n                            const SizedBox(height: 12),\r\n                            Center(\r\n                              child: FilledButton(\r\n                                onPressed: () => _load(context),\r\n                                child: const Text('Retry'),\r\n                              ),\r\n                            ),\r\n                          ],\r\n                        ),\r\n                      _ => ListView(\r\n                          children: const [\r\n                            SizedBox(height: 120),\r\n                            Center(child: CircularProgressIndicator()),\r\n                          ],\r\n                        ),\r\n                    },\r\n                  ),\r\n                ),\r\n              ],\r\n            ),\r\n            floatingActionButton: FloatingActionButton.extended(\r\n              heroTag: 'trips_list_fab',\r\n              onPressed: () => context.push(RoutePaths.tripsCreate),\r\n              icon: const Icon(Icons.add),\r\n              label: const Text('Post Trip'),\r\n            ),\r\n          );\r\n        },\r\n      ),\r\n    );\r\n  }\r\n}\r\n"
        }
    ]
}