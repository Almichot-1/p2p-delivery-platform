{
    "sourceFile": "lib/features/trips/presentation/screens/create_trip_screen.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768056786329,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768056786329,
            "name": "Commit-0",
            "content": "import 'package:flutter/material.dart';\r\nimport 'package:flutter_bloc/flutter_bloc.dart';\r\nimport 'package:get_it/get_it.dart';\r\nimport 'package:go_router/go_router.dart';\r\n\r\nimport '../../../auth/bloc/auth_bloc.dart';\r\nimport '../../../auth/bloc/auth_state.dart';\r\nimport '../../bloc/trip_bloc.dart';\r\nimport '../../bloc/trip_event.dart';\r\nimport '../../bloc/trip_state.dart';\r\nimport '../../data/models/trip_model.dart';\r\n\r\nclass CreateTripScreen extends StatefulWidget {\r\n  const CreateTripScreen({super.key, this.existing});\r\n\r\n  final TripModel? existing;\r\n\r\n  @override\r\n  State<CreateTripScreen> createState() => _CreateTripScreenState();\r\n}\r\n\r\nclass _CreateTripScreenState extends State<CreateTripScreen> {\r\n  static const List<String> _itemTypes = <String>[\r\n    'Documents',\r\n    'Electronics',\r\n    'Clothing',\r\n    'Food (sealed)',\r\n    'Medicine',\r\n    'Other',\r\n  ];\r\n\r\n  // Countries with their cities\r\n  static const Map<String, List<String>> _countryCities = {\r\n    'Ethiopia': ['Addis Ababa', 'Adama', 'Bahir Dar', 'Gondar', 'Hawassa', 'Dire Dawa', 'Mekelle', 'Jimma', 'Dessie', 'Harar'],\r\n    'United States': ['New York', 'Los Angeles', 'Washington DC', 'Chicago', 'Houston', 'Miami', 'San Francisco', 'Seattle', 'Boston', 'Atlanta'],\r\n    'United Arab Emirates': ['Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman'],\r\n    'Saudi Arabia': ['Riyadh', 'Jeddah', 'Mecca', 'Medina', 'Dammam'],\r\n    'Qatar': ['Doha', 'Al Wakrah', 'Al Khor'],\r\n    'Kuwait': ['Kuwait City', 'Hawalli', 'Salmiya'],\r\n    'Bahrain': ['Manama', 'Riffa', 'Muharraq'],\r\n    'Oman': ['Muscat', 'Salalah', 'Sohar'],\r\n    'Canada': ['Toronto', 'Vancouver', 'Montreal', 'Calgary', 'Ottawa'],\r\n    'United Kingdom': ['London', 'Manchester', 'Birmingham', 'Liverpool', 'Edinburgh'],\r\n    'Germany': ['Berlin', 'Munich', 'Frankfurt', 'Hamburg', 'Cologne'],\r\n    'France': ['Paris', 'Lyon', 'Marseille', 'Nice', 'Toulouse'],\r\n    'Italy': ['Rome', 'Milan', 'Naples', 'Turin', 'Florence'],\r\n    'Netherlands': ['Amsterdam', 'Rotterdam', 'The Hague', 'Utrecht'],\r\n    'Sweden': ['Stockholm', 'Gothenburg', 'Malmö'],\r\n    'Norway': ['Oslo', 'Bergen', 'Trondheim'],\r\n    'Australia': ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide'],\r\n    'Turkey': ['Istanbul', 'Ankara', 'Izmir', 'Antalya'],\r\n    'South Africa': ['Johannesburg', 'Cape Town', 'Durban', 'Pretoria'],\r\n    'Kenya': ['Nairobi', 'Mombasa', 'Kisumu'],\r\n    'Egypt': ['Cairo', 'Alexandria', 'Giza'],\r\n    'Israel': ['Tel Aviv', 'Jerusalem', 'Haifa'],\r\n    'India': ['Mumbai', 'Delhi', 'Bangalore', 'Chennai', 'Kolkata'],\r\n    'China': ['Beijing', 'Shanghai', 'Guangzhou', 'Shenzhen'],\r\n    'Japan': ['Tokyo', 'Osaka', 'Kyoto', 'Yokohama'],\r\n    'South Korea': ['Seoul', 'Busan', 'Incheon'],\r\n    'Singapore': ['Singapore'],\r\n    'Malaysia': ['Kuala Lumpur', 'Penang', 'Johor Bahru'],\r\n    'Thailand': ['Bangkok', 'Chiang Mai', 'Phuket'],\r\n    'Other': [],\r\n  };\r\n\r\n  final _formKey = GlobalKey<FormState>();\r\n\r\n  // Trip direction: true = Ethiopia to Abroad, false = Abroad to Ethiopia\r\n  bool _isOutbound = true;\r\n\r\n  // Origin\r\n  String? _originCountry;\r\n  String? _originCity;\r\n  final _originCityCtrl = TextEditingController();\r\n  bool _showOriginManualCity = false;\r\n\r\n  // Destination\r\n  String? _destinationCountry;\r\n  String? _destinationCity;\r\n  final _destinationCityCtrl = TextEditingController();\r\n  bool _showDestinationManualCity = false;\r\n\r\n  DateTime? _departureDate;\r\n  DateTime? _returnDate;\r\n\r\n  final _capacityCtrl = TextEditingController();\r\n  final _priceCtrl = TextEditingController();\r\n  final _notesCtrl = TextEditingController();\r\n\r\n  final Set<String> _selectedTypes = <String>{};\r\n\r\n  bool get _isEdit => widget.existing != null;\r\n\r\n  List<String> get _countries => _countryCities.keys.toList();\r\n\r\n  List<String> _getCities(String? country) {\r\n    if (country == null || country == 'Other') return [];\r\n    return _countryCities[country] ?? [];\r\n  }\r\n\r\n  @override\r\n  void initState() {\r\n    super.initState();\r\n    final t = widget.existing;\r\n    if (t != null) {\r\n      _isOutbound = t.originCountry == 'Ethiopia';\r\n      _originCountry = t.originCountry;\r\n      _originCity = t.originCity;\r\n      _originCityCtrl.text = t.originCity;\r\n      _destinationCountry = t.destinationCountry;\r\n      _destinationCity = t.destinationCity;\r\n      _destinationCityCtrl.text = t.destinationCity;\r\n      _departureDate = t.departureDate;\r\n      _returnDate = t.returnDate;\r\n      _capacityCtrl.text = t.availableCapacityKg.toStringAsFixed(1);\r\n      _priceCtrl.text = t.pricePerKg?.toStringAsFixed(2) ?? '';\r\n      _notesCtrl.text = t.notes ?? '';\r\n      _selectedTypes.addAll(t.acceptedItemTypes);\r\n    } else {\r\n      _originCountry = 'Ethiopia';\r\n    }\r\n  }\r\n\r\n  @override\r\n  void dispose() {\r\n    _originCityCtrl.dispose();\r\n    _destinationCityCtrl.dispose();\r\n    _capacityCtrl.dispose();\r\n    _priceCtrl.dispose();\r\n    _notesCtrl.dispose();\r\n    super.dispose();\r\n  }\r\n\r\n  void _toggleDirection() {\r\n    setState(() {\r\n      _isOutbound = !_isOutbound;\r\n      // Swap\r\n      final tempCountry = _originCountry;\r\n      final tempCity = _originCity;\r\n      final tempCityText = _originCityCtrl.text;\r\n      final tempShowManual = _showOriginManualCity;\r\n\r\n      _originCountry = _destinationCountry;\r\n      _originCity = _destinationCity;\r\n      _originCityCtrl.text = _destinationCityCtrl.text;\r\n      _showOriginManualCity = _showDestinationManualCity;\r\n\r\n      _destinationCountry = tempCountry;\r\n      _destinationCity = tempCity;\r\n      _destinationCityCtrl.text = tempCityText;\r\n      _showDestinationManualCity = tempShowManual;\r\n\r\n      // Set Ethiopia as default for appropriate side\r\n      if (_isOutbound) {\r\n        _originCountry = 'Ethiopia';\r\n        _originCity = null;\r\n        _originCityCtrl.clear();\r\n        _showOriginManualCity = false;\r\n      } else {\r\n        _destinationCountry = 'Ethiopia';\r\n        _destinationCity = null;\r\n        _destinationCityCtrl.clear();\r\n        _showDestinationManualCity = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  Future<void> _pickDepartureDate() async {\r\n    final now = DateTime.now();\r\n    final picked = await showDatePicker(\r\n      context: context,\r\n      initialDate: _departureDate ?? now,\r\n      firstDate: now,\r\n      lastDate: DateTime(now.year + 2),\r\n    );\r\n    if (picked == null) return;\r\n    setState(() {\r\n      _departureDate = picked;\r\n      if (_returnDate != null && _returnDate!.isBefore(picked)) {\r\n        _returnDate = null;\r\n      }\r\n    });\r\n  }\r\n\r\n  Future<void> _pickReturnDate() async {\r\n    final dep = _departureDate;\r\n    if (dep == null) {\r\n      ScaffoldMessenger.of(context).showSnackBar(\r\n        const SnackBar(content: Text('Pick departure date first')),\r\n      );\r\n      return;\r\n    }\r\n    final picked = await showDatePicker(\r\n      context: context,\r\n      initialDate: _returnDate ?? dep,\r\n      firstDate: dep,\r\n      lastDate: DateTime(dep.year + 2),\r\n    );\r\n    if (picked != null) setState(() => _returnDate = picked);\r\n  }\r\n\r\n  void _toggleType(String t, bool selected) {\r\n    setState(() {\r\n      if (selected) {\r\n        _selectedTypes.add(t);\r\n      } else {\r\n        _selectedTypes.remove(t);\r\n      }\r\n    });\r\n  }\r\n\r\n  void _submit(BuildContext blocContext) {\r\n    if (!_formKey.currentState!.validate()) return;\r\n\r\n    final authState = context.read<AuthBloc>().state;\r\n    if (authState is! AuthAuthenticated) {\r\n      ScaffoldMessenger.of(context).showSnackBar(\r\n        const SnackBar(content: Text('Please log in first')),\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (_departureDate == null) {\r\n      ScaffoldMessenger.of(context).showSnackBar(\r\n        const SnackBar(content: Text('Departure date is required')),\r\n      );\r\n      return;\r\n    }\r\n\r\n    final capacity = double.tryParse(_capacityCtrl.text.trim());\r\n    if (capacity == null) return;\r\n\r\n    final price = _priceCtrl.text.trim().isEmpty ? null : double.tryParse(_priceCtrl.text.trim());\r\n\r\n    final originCountry = (_originCountry ?? '').trim();\r\n    final originCity = _originCity?.trim() ?? _originCityCtrl.text.trim();\r\n    final destCountry = (_destinationCountry ?? '').trim();\r\n    final destCity = _destinationCity?.trim() ?? _destinationCityCtrl.text.trim();\r\n\r\n    if (originCountry.isEmpty || originCity.isEmpty) {\r\n      ScaffoldMessenger.of(context).showSnackBar(\r\n        const SnackBar(content: Text('Origin location required')),\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (destCountry.isEmpty || destCity.isEmpty) {\r\n      ScaffoldMessenger.of(context).showSnackBar(\r\n        const SnackBar(content: Text('Destination location required')),\r\n      );\r\n      return;\r\n    }\r\n\r\n    final trip = TripModel(\r\n      id: widget.existing?.id ?? '',\r\n      travelerId: authState.user.uid,\r\n      travelerName: authState.user.fullName,\r\n      travelerPhoto: authState.user.photoUrl,\r\n      travelerRating: authState.user.rating,\r\n      originCity: originCity,\r\n      originCountry: originCountry,\r\n      destinationCity: destCity,\r\n      destinationCountry: destCountry,\r\n      departureDate: _departureDate!,\r\n      returnDate: _returnDate,\r\n      availableCapacityKg: capacity,\r\n      pricePerKg: price,\r\n      acceptedItemTypes: _selectedTypes.toList(),\r\n      notes: _notesCtrl.text.trim().isEmpty ? null : _notesCtrl.text.trim(),\r\n      status: widget.existing?.status ?? TripStatus.active,\r\n      matchCount: widget.existing?.matchCount ?? 0,\r\n      createdAt: widget.existing?.createdAt,\r\n      updatedAt: widget.existing?.updatedAt,\r\n    );\r\n\r\n    if (_isEdit) {\r\n      blocContext.read<TripBloc>().add(TripUpdateRequested(trip));\r\n    } else {\r\n      blocContext.read<TripBloc>().add(TripCreateRequested(trip));\r\n    }\r\n  }\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    return BlocBuilder<AuthBloc, AuthState>(\r\n      builder: (context, authState) {\r\n        if (authState is! AuthAuthenticated) {\r\n          return const Scaffold(body: Center(child: Text('Please log in')));\r\n        }\r\n\r\n        return BlocProvider<TripBloc>(\r\n          create: (_) => GetIt.instance<TripBloc>(),\r\n          child: BlocConsumer<TripBloc, TripState>(\r\n            listenWhen: (_, s) => s is TripError || s is TripCreated || s is TripUpdated,\r\n            listener: (context, state) {\r\n              if (state is TripError) {\r\n                ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(state.message)));\r\n              }\r\n              if (state is TripCreated || state is TripUpdated) {\r\n                ScaffoldMessenger.of(context).showSnackBar(\r\n                  SnackBar(content: Text(_isEdit ? 'Trip updated' : 'Trip posted')),\r\n                );\r\n                context.pop();\r\n              }\r\n            },\r\n            builder: (context, state) {\r\n              final submitting = state is TripCreating;\r\n\r\n              return Scaffold(\r\n                appBar: AppBar(title: Text(_isEdit ? 'Edit Trip' : 'Post a Trip')),\r\n                body: Form(\r\n                  key: _formKey,\r\n                  child: ListView(\r\n                    padding: const EdgeInsets.all(16),\r\n                    children: [\r\n                      // Direction toggle\r\n                      Card(\r\n                        child: Padding(\r\n                          padding: const EdgeInsets.all(12),\r\n                          child: Row(\r\n                            children: [\r\n                              Expanded(\r\n                                child: Column(\r\n                                  crossAxisAlignment: CrossAxisAlignment.start,\r\n                                  children: [\r\n                                    Text('Trip Direction', style: Theme.of(context).textTheme.titleSmall),\r\n                                    const SizedBox(height: 4),\r\n                                    Text(\r\n                                      _isOutbound ? 'Ethiopia → Abroad' : 'Abroad → Ethiopia',\r\n                                      style: Theme.of(context).textTheme.bodyLarge?.copyWith(\r\n                                        fontWeight: FontWeight.bold,\r\n                                        color: Theme.of(context).colorScheme.primary,\r\n                                      ),\r\n                                    ),\r\n                                  ],\r\n                                ),\r\n                              ),\r\n                              IconButton.filled(\r\n                                onPressed: submitting ? null : _toggleDirection,\r\n                                icon: const Icon(Icons.swap_horiz),\r\n                              ),\r\n                            ],\r\n                          ),\r\n                        ),\r\n                      ),\r\n                      const SizedBox(height: 16),\r\n\r\n                      // Origin\r\n                      Text('From', style: Theme.of(context).textTheme.titleMedium),\r\n                      const SizedBox(height: 8),\r\n                      _buildLocationSection(\r\n                        isOrigin: true,\r\n                        isFixed: _isOutbound,\r\n                        enabled: !submitting,\r\n                      ),\r\n                      const SizedBox(height: 16),\r\n\r\n                      // Destination\r\n                      Text('To', style: Theme.of(context).textTheme.titleMedium),\r\n                      const SizedBox(height: 8),\r\n                      _buildLocationSection(\r\n                        isOrigin: false,\r\n                        isFixed: !_isOutbound,\r\n                        enabled: !submitting,\r\n                      ),\r\n                      const SizedBox(height: 16),\r\n\r\n                      // Dates\r\n                      Row(\r\n                        children: [\r\n                          Expanded(\r\n                            child: OutlinedButton.icon(\r\n                              onPressed: submitting ? null : _pickDepartureDate,\r\n                              icon: const Icon(Icons.flight_takeoff, size: 18),\r\n                              label: Text(_departureDate == null\r\n                                  ? 'Departure *'\r\n                                  : '${_departureDate!.day}/${_departureDate!.month}/${_departureDate!.year}'),\r\n                            ),\r\n                          ),\r\n                          const SizedBox(width: 12),\r\n                          Expanded(\r\n                            child: OutlinedButton.icon(\r\n                              onPressed: submitting ? null : _pickReturnDate,\r\n                              icon: const Icon(Icons.flight_land, size: 18),\r\n                              label: Text(_returnDate == null\r\n                                  ? 'Return'\r\n                                  : '${_returnDate!.day}/${_returnDate!.month}/${_returnDate!.year}'),\r\n                            ),\r\n                          ),\r\n                        ],\r\n                      ),\r\n                      const SizedBox(height: 16),\r\n\r\n                      // Capacity & Price\r\n                      Row(\r\n                        children: [\r\n                          Expanded(\r\n                            child: TextFormField(\r\n                              controller: _capacityCtrl,\r\n                              enabled: !submitting,\r\n                              keyboardType: const TextInputType.numberWithOptions(decimal: true),\r\n                              decoration: const InputDecoration(\r\n                                labelText: 'Capacity (kg) *',\r\n                                border: OutlineInputBorder(),\r\n                              ),\r\n                              validator: (v) {\r\n                                final x = double.tryParse(v?.trim() ?? '');\r\n                                if (x == null) return 'Required';\r\n                                if (x < 0.1 || x > 50) return '0.1-50 kg';\r\n                                return null;\r\n                              },\r\n                            ),\r\n                          ),\r\n                          const SizedBox(width: 12),\r\n                          Expanded(\r\n                            child: TextFormField(\r\n                              controller: _priceCtrl,\r\n                              enabled: !submitting,\r\n                              keyboardType: const TextInputType.numberWithOptions(decimal: true),\r\n                              decoration: const InputDecoration(\r\n                                labelText: 'Price/kg',\r\n                                border: OutlineInputBorder(),\r\n                              ),\r\n                            ),\r\n                          ),\r\n                        ],\r\n                      ),\r\n                      const SizedBox(height: 16),\r\n\r\n                      // Item types\r\n                      Text('Accepted items', style: Theme.of(context).textTheme.titleSmall),\r\n                      const SizedBox(height: 8),\r\n                      Wrap(\r\n                        spacing: 8,\r\n                        runSpacing: 8,\r\n                        children: _itemTypes.map((t) => FilterChip(\r\n                          label: Text(t),\r\n                          selected: _selectedTypes.contains(t),\r\n                          onSelected: submitting ? null : (v) => _toggleType(t, v),\r\n                        )).toList(),\r\n                      ),\r\n                      const SizedBox(height: 16),\r\n\r\n                      // Notes\r\n                      TextFormField(\r\n                        controller: _notesCtrl,\r\n                        enabled: !submitting,\r\n                        maxLines: 2,\r\n                        decoration: const InputDecoration(\r\n                          labelText: 'Notes (optional)',\r\n                          border: OutlineInputBorder(),\r\n                        ),\r\n                      ),\r\n                      const SizedBox(height: 24),\r\n\r\n                      FilledButton.icon(\r\n                        onPressed: submitting ? null : () => _submit(context),\r\n                        icon: const Icon(Icons.check),\r\n                        label: Text(_isEdit ? 'Save Changes' : 'Post Trip'),\r\n                      ),\r\n                    ],\r\n                  ),\r\n                ),\r\n              );\r\n            },\r\n          ),\r\n        );\r\n      },\r\n    );\r\n  }\r\n\r\n  Widget _buildLocationSection({\r\n    required bool isOrigin,\r\n    required bool isFixed,\r\n    required bool enabled,\r\n  }) {\r\n    final country = isOrigin ? _originCountry : _destinationCountry;\r\n    final city = isOrigin ? _originCity : _destinationCity;\r\n    final cityCtrl = isOrigin ? _originCityCtrl : _destinationCityCtrl;\r\n    final showManualInput = isOrigin ? _showOriginManualCity : _showDestinationManualCity;\r\n    final cities = _getCities(country);\r\n\r\n    return Column(\r\n      children: [\r\n        // Country dropdown\r\n        DropdownButtonFormField<String>(\r\n          initialValue: isFixed ? 'Ethiopia' : (country != null && _countries.contains(country) ? country : null),\r\n          decoration: InputDecoration(\r\n            labelText: isFixed ? 'Ethiopia' : 'Country *',\r\n            border: const OutlineInputBorder(),\r\n          ),\r\n          items: (isFixed ? ['Ethiopia'] : _countries).map((c) => DropdownMenuItem(value: c, child: Text(c))).toList(),\r\n          onChanged: (isFixed || !enabled) ? null : (v) {\r\n            setState(() {\r\n              if (isOrigin) {\r\n                _originCountry = v;\r\n                _originCity = null;\r\n                _originCityCtrl.clear();\r\n                _showOriginManualCity = false;\r\n              } else {\r\n                _destinationCountry = v;\r\n                _destinationCity = null;\r\n                _destinationCityCtrl.clear();\r\n                _showDestinationManualCity = false;\r\n              }\r\n            });\r\n          },\r\n        ),\r\n        const SizedBox(height: 12),\r\n\r\n        // City - dropdown if cities available and not showing manual input\r\n        if (cities.isNotEmpty && !showManualInput)\r\n          DropdownButtonFormField<String>(\r\n            initialValue: city != null && cities.contains(city) ? city : null,\r\n            decoration: const InputDecoration(\r\n              labelText: 'City *',\r\n              border: OutlineInputBorder(),\r\n            ),\r\n            items: [\r\n              ...cities.map((c) => DropdownMenuItem(value: c, child: Text(c))),\r\n              const DropdownMenuItem(value: '__other__', child: Text('Other (enter manually)')),\r\n            ],\r\n            onChanged: enabled ? (v) {\r\n              setState(() {\r\n                if (v == '__other__') {\r\n                  if (isOrigin) {\r\n                    _originCity = null;\r\n                    _originCityCtrl.clear();\r\n                    _showOriginManualCity = true;\r\n                  } else {\r\n                    _destinationCity = null;\r\n                    _destinationCityCtrl.clear();\r\n                    _showDestinationManualCity = true;\r\n                  }\r\n                } else {\r\n                  if (isOrigin) {\r\n                    _originCity = v;\r\n                    _originCityCtrl.text = v ?? '';\r\n                  } else {\r\n                    _destinationCity = v;\r\n                    _destinationCityCtrl.text = v ?? '';\r\n                  }\r\n                }\r\n              });\r\n            } : null,\r\n          ),\r\n\r\n        // Show manual input when \"Other\" selected or country has no cities\r\n        if (showManualInput || country == 'Other' || (country != null && cities.isEmpty))\r\n          Column(\r\n            children: [\r\n              TextFormField(\r\n                controller: cityCtrl,\r\n                enabled: enabled,\r\n                decoration: const InputDecoration(\r\n                  labelText: 'City *',\r\n                  hintText: 'Enter city name',\r\n                  border: OutlineInputBorder(),\r\n                ),\r\n                validator: (v) => v?.trim().isEmpty == true ? 'Required' : null,\r\n              ),\r\n              if (showManualInput && cities.isNotEmpty)\r\n                Align(\r\n                  alignment: Alignment.centerLeft,\r\n                  child: TextButton.icon(\r\n                    onPressed: enabled ? () {\r\n                      setState(() {\r\n                        if (isOrigin) {\r\n                          _showOriginManualCity = false;\r\n                          _originCityCtrl.clear();\r\n                        } else {\r\n                          _showDestinationManualCity = false;\r\n                          _destinationCityCtrl.clear();\r\n                        }\r\n                      });\r\n                    } : null,\r\n                    icon: const Icon(Icons.arrow_back, size: 16),\r\n                    label: const Text('Back to city list'),\r\n                  ),\r\n                ),\r\n            ],\r\n          ),\r\n      ],\r\n    );\r\n  }\r\n}\r\n"
        }
    ]
}