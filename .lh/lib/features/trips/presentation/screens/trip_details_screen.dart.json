{
    "sourceFile": "lib/features/trips/presentation/screens/trip_details_screen.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1768061417795,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1768062402732,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -303,17 +303,19 @@\n                   ],\r\n                   const SizedBox(height: 12),\r\n                   if (!isOwner)\r\n                       FilledButton.icon(\r\n-                        onPressed: () {\r\n-                          // Pass the trip to pre-fill the request\r\n-                          context.push(\r\n-                            RoutePaths.requestsCreate,\r\n-                            extra: CreateRequestFromTrip(trip: trip),\r\n-                          );\r\n-                        },\r\n+                        onPressed: trip.isUpcoming\r\n+                            ? () {\r\n+                                // Pass the trip to pre-fill the request\r\n+                                context.push(\r\n+                                  RoutePaths.requestsCreate,\r\n+                                  extra: CreateRequestFromTrip(trip: trip),\r\n+                                );\r\n+                              }\r\n+                            : null,\r\n                         icon: const Icon(Icons.chat_bubble_outline),\r\n-                        label: const Text('Contact Traveler'),\r\n+                        label: Text(trip.isUpcoming ? 'Contact Traveler' : 'Trip ended'),\r\n                       ),\r\n                 ],\r\n               ),\r\n             ),\r\n"
                }
            ],
            "date": 1768061417795,
            "name": "Commit-0",
            "content": "import 'package:flutter/material.dart';\r\nimport 'package:flutter_bloc/flutter_bloc.dart';\r\nimport 'package:get_it/get_it.dart';\r\nimport 'package:go_router/go_router.dart';\r\nimport 'package:intl/intl.dart';\r\n\r\nimport '../../../../config/routes.dart';\r\nimport '../../../auth/bloc/auth_bloc.dart';\r\nimport '../../../auth/bloc/auth_state.dart';\r\nimport '../../../../core/widgets/cached_image.dart';\r\nimport '../../../requests/presentation/screens/create_request_screen.dart';\r\nimport '../../bloc/trip_bloc.dart';\r\nimport '../../bloc/trip_event.dart';\r\nimport '../../bloc/trip_state.dart';\r\nimport '../../data/models/trip_model.dart';\r\n\r\nclass TripDetailsScreen extends StatelessWidget {\r\n  const TripDetailsScreen({super.key, required this.tripId});\r\n\r\n  final String tripId;\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    return BlocProvider<TripBloc>(\r\n      create: (_) => GetIt.instance<TripBloc>()..add(TripDetailsRequested(tripId)),\r\n      child: BlocConsumer<TripBloc, TripState>(\r\n        listenWhen: (_, s) => s is TripError || s is TripCancelled,\r\n        listener: (context, state) {\r\n          if (state is TripError) {\r\n            ScaffoldMessenger.of(context).showSnackBar(\r\n              SnackBar(content: Text(state.message)),\r\n            );\r\n          }\r\n          if (state is TripCancelled) {\r\n            ScaffoldMessenger.of(context).showSnackBar(\r\n              const SnackBar(content: Text('Trip cancelled')),\r\n            );\r\n          }\r\n        },\r\n        builder: (context, state) {\r\n          return switch (state) {\r\n            TripLoading() => const Scaffold(\r\n                body: Center(child: CircularProgressIndicator()),\r\n              ),\r\n            TripDetailsLoaded() => _TripDetailsBody(trip: state.trip),\r\n            TripError() => Scaffold(\r\n                appBar: AppBar(title: const Text('Trip')),\r\n                body: Center(child: Text(state.message)),\r\n              ),\r\n            _ => const Scaffold(body: Center(child: CircularProgressIndicator())),\r\n          };\r\n        },\r\n      ),\r\n    );\r\n  }\r\n}\r\n\r\nclass _TripDetailsBody extends StatelessWidget {\r\n  const _TripDetailsBody({required this.trip});\r\n\r\n  final TripModel trip;\r\n\r\n  Future<void> _cancelTrip(BuildContext context) async {\r\n    final ok = await showDialog<bool>(\r\n      context: context,\r\n      builder: (context) {\r\n        return AlertDialog(\r\n          title: const Text('Cancel trip'),\r\n          content: const Text('Are you sure you want to cancel this trip?'),\r\n          actions: [\r\n            TextButton(\r\n              onPressed: () => Navigator.pop(context, false),\r\n              child: const Text('No'),\r\n            ),\r\n            FilledButton(\r\n              onPressed: () => Navigator.pop(context, true),\r\n              child: const Text('Cancel Trip'),\r\n            ),\r\n          ],\r\n        );\r\n      },\r\n    );\r\n\r\n    if (ok != true || !context.mounted) return;\r\n    context.read<TripBloc>().add(TripCancelRequested(trip.id));\r\n  }\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    final theme = Theme.of(context);\r\n    final scheme = theme.colorScheme;\r\n\r\n    final dateFmt = DateFormat('EEE, MMM d');\r\n\r\n    final authState = context.read<AuthBloc>().state;\r\n    final isOwner = authState is AuthAuthenticated && authState.user.uid == trip.travelerId;\r\n\r\n    return Scaffold(\r\n      body: CustomScrollView(\r\n        slivers: [\r\n          SliverAppBar(\r\n            pinned: true,\r\n            expandedHeight: 180,\r\n            title: Text('${trip.originCountry} → ${trip.destinationCountry}'),\r\n            flexibleSpace: FlexibleSpaceBar(\r\n              background: Container(\r\n                decoration: BoxDecoration(\r\n                  gradient: LinearGradient(\r\n                    colors: [scheme.primary, scheme.secondary],\r\n                    begin: Alignment.topLeft,\r\n                    end: Alignment.bottomRight,\r\n                  ),\r\n                ),\r\n                alignment: Alignment.bottomLeft,\r\n                padding: const EdgeInsets.fromLTRB(16, 0, 16, 24),\r\n                child: Column(\r\n                  crossAxisAlignment: CrossAxisAlignment.start,\r\n                  mainAxisAlignment: MainAxisAlignment.end,\r\n                  children: [\r\n                    Row(\r\n                      children: [\r\n                        _StatusBadge(status: trip.status),\r\n                        const SizedBox(width: 10),\r\n                        Text(\r\n                          'Trip route',\r\n                          style: theme.textTheme.labelLarge?.copyWith(\r\n                            color: scheme.onPrimary.withAlpha((0.9 * 255).round()),\r\n                          ),\r\n                        ),\r\n                      ],\r\n                    ),\r\n                    const SizedBox(height: 10),\r\n                    Row(\r\n                      children: [\r\n                        Expanded(\r\n                          child: _HeaderLocationStack(\r\n                            country: trip.originCountry,\r\n                            city: trip.originCity,\r\n                          ),\r\n                        ),\r\n                        Padding(\r\n                          padding: const EdgeInsets.symmetric(horizontal: 12),\r\n                          child: Icon(\r\n                            Icons.arrow_forward,\r\n                            size: 20,\r\n                            color: scheme.onPrimary.withAlpha((0.9 * 255).round()),\r\n                          ),\r\n                        ),\r\n                        Expanded(\r\n                          child: _HeaderLocationStack(\r\n                            country: trip.destinationCountry,\r\n                            city: trip.destinationCity,\r\n                          ),\r\n                        ),\r\n                      ],\r\n                    ),\r\n                  ],\r\n                ),\r\n              ),\r\n            ),\r\n            actions: [\r\n              if (isOwner)\r\n                PopupMenuButton<String>(\r\n                  onSelected: (v) {\r\n                    if (v == 'edit') {\r\n                      context.push(RoutePaths.tripsCreate, extra: trip);\r\n                    }\r\n                    if (v == 'cancel') {\r\n                      _cancelTrip(context);\r\n                    }\r\n                  },\r\n                  itemBuilder: (context) => [\r\n                    const PopupMenuItem<String>(\r\n                      value: 'edit',\r\n                      child: Text('Edit'),\r\n                    ),\r\n                    const PopupMenuItem<String>(\r\n                      value: 'cancel',\r\n                      child: Text('Cancel'),\r\n                    ),\r\n                  ],\r\n                ),\r\n            ],\r\n          ),\r\n          SliverToBoxAdapter(\r\n            child: Padding(\r\n              padding: const EdgeInsets.all(16),\r\n              child: Column(\r\n                crossAxisAlignment: CrossAxisAlignment.start,\r\n                children: [\r\n                  Card(\r\n                    child: Padding(\r\n                      padding: const EdgeInsets.all(14),\r\n                      child: Row(\r\n                        children: [\r\n                          ProfileImage(\r\n                            displayName: trip.travelerName,\r\n                            imageUrl: trip.travelerPhoto,\r\n                            size: 48,\r\n                          ),\r\n                          const SizedBox(width: 12),\r\n                          Expanded(\r\n                            child: Column(\r\n                              crossAxisAlignment: CrossAxisAlignment.start,\r\n                              children: [\r\n                                Text(trip.travelerName, style: theme.textTheme.titleMedium),\r\n                                const SizedBox(height: 4),\r\n                                Row(\r\n                                  children: [\r\n                                    const Icon(Icons.star, size: 16),\r\n                                    const SizedBox(width: 4),\r\n                                    Text(trip.travelerRating.toStringAsFixed(1)),\r\n                                  ],\r\n                                ),\r\n                              ],\r\n                            ),\r\n                          ),\r\n                          IconButton(\r\n                            onPressed: () {\r\n                              context.push('/profile/${trip.travelerId}');\r\n                            },\r\n                            icon: const Icon(Icons.chevron_right),\r\n                            tooltip: 'View profile',\r\n                          ),\r\n                        ],\r\n                      ),\r\n                    ),\r\n                  ),\r\n                  const SizedBox(height: 12),\r\n                  Card(\r\n                    child: Padding(\r\n                      padding: const EdgeInsets.all(14),\r\n                      child: Column(\r\n                        crossAxisAlignment: CrossAxisAlignment.start,\r\n                        children: [\r\n                          Text('Trip info', style: theme.textTheme.titleSmall),\r\n                          const SizedBox(height: 10),\r\n                          _InfoRow(\r\n                            icon: Icons.calendar_today_outlined,\r\n                            label: 'Departure',\r\n                            value: dateFmt.format(trip.departureDate),\r\n                          ),\r\n                          if (trip.returnDate != null) ...[\r\n                            const SizedBox(height: 8),\r\n                            _InfoRow(\r\n                              icon: Icons.event_repeat_outlined,\r\n                              label: 'Return',\r\n                              value: dateFmt.format(trip.returnDate!),\r\n                            ),\r\n                          ],\r\n                          const SizedBox(height: 8),\r\n                          _InfoRow(\r\n                            icon: Icons.scale_outlined,\r\n                            label: 'Capacity',\r\n                            value: '${trip.availableCapacityKg.toStringAsFixed(1)} kg',\r\n                          ),\r\n                          if (trip.pricePerKg != null) ...[\r\n                            const SizedBox(height: 8),\r\n                            _InfoRow(\r\n                              icon: Icons.payments_outlined,\r\n                              label: 'Price',\r\n                              value: '${trip.pricePerKg!.toStringAsFixed(2)}/kg',\r\n                            ),\r\n                          ],\r\n                        ],\r\n                      ),\r\n                    ),\r\n                  ),\r\n                  const SizedBox(height: 12),\r\n                  if (trip.acceptedItemTypes.isNotEmpty) ...[\r\n                    Text('Accepted item types', style: theme.textTheme.titleSmall),\r\n                    const SizedBox(height: 8),\r\n                    Wrap(\r\n                      spacing: 8,\r\n                      runSpacing: 8,\r\n                      children: [\r\n                        for (final t in trip.acceptedItemTypes)\r\n                          InputChip(\r\n                            label: Text(t),\r\n                            onPressed: null,\r\n                          ),\r\n                      ],\r\n                    ),\r\n                    const SizedBox(height: 12),\r\n                  ],\r\n                  if (trip.notes != null && trip.notes!.trim().isNotEmpty) ...[\r\n                    Text('Notes', style: theme.textTheme.titleSmall),\r\n                    const SizedBox(height: 8),\r\n                    Text(trip.notes!, style: theme.textTheme.bodyMedium),\r\n                    const SizedBox(height: 12),\r\n                  ],\r\n                  if (isOwner && trip.status == TripStatus.active) ...[\r\n                    FilledButton.icon(\r\n                      onPressed: trip.isUpcoming\r\n                          ? () => context.push(\r\n                                '${RoutePaths.trips}/${trip.id}/matching-requests',\r\n                              )\r\n                          : null,\r\n                      icon: const Icon(Icons.link),\r\n                      label: const Text('Find Requests to Carry'),\r\n                    ),\r\n                    const SizedBox(height: 12),\r\n                  ],\r\n                  const SizedBox(height: 12),\r\n                  if (!isOwner)\r\n                      FilledButton.icon(\r\n                        onPressed: () {\r\n                          // Pass the trip to pre-fill the request\r\n                          context.push(\r\n                            RoutePaths.requestsCreate,\r\n                            extra: CreateRequestFromTrip(trip: trip),\r\n                          );\r\n                        },\r\n                        icon: const Icon(Icons.chat_bubble_outline),\r\n                        label: const Text('Contact Traveler'),\r\n                      ),\r\n                ],\r\n              ),\r\n            ),\r\n          ),\r\n        ],\r\n      ),\r\n    );\r\n  }\r\n}\r\n\r\nclass _HeaderLocationStack extends StatelessWidget {\r\n  const _HeaderLocationStack({required this.country, required this.city});\r\n\r\n  final String country;\r\n  final String city;\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    final theme = Theme.of(context);\r\n    final scheme = theme.colorScheme;\r\n\r\n    final countryText = country.trim().isEmpty ? '—' : country.trim();\r\n    final cityText = city.trim().isEmpty ? '—' : city.trim();\r\n\r\n    return Column(\r\n      crossAxisAlignment: CrossAxisAlignment.start,\r\n      children: [\r\n        Text(\r\n          countryText,\r\n          style: theme.textTheme.titleLarge?.copyWith(\r\n            color: scheme.onPrimary,\r\n            fontWeight: FontWeight.w700,\r\n          ),\r\n          maxLines: 1,\r\n          overflow: TextOverflow.ellipsis,\r\n        ),\r\n        const SizedBox(height: 2),\r\n        Text(\r\n          cityText,\r\n          style: theme.textTheme.bodyMedium?.copyWith(\r\n            color: scheme.onPrimary.withAlpha((0.9 * 255).round()),\r\n          ),\r\n          maxLines: 1,\r\n          overflow: TextOverflow.ellipsis,\r\n        ),\r\n      ],\r\n    );\r\n  }\r\n}\r\n\r\nclass _StatusBadge extends StatelessWidget {\r\n  const _StatusBadge({required this.status});\r\n\r\n  final TripStatus status;\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    final scheme = Theme.of(context).colorScheme;\r\n\r\n    final bg = switch (status) {\r\n      TripStatus.active => scheme.primaryContainer,\r\n      TripStatus.completed => scheme.secondaryContainer,\r\n      TripStatus.cancelled => scheme.errorContainer,\r\n    };\r\n\r\n    final fg = switch (status) {\r\n      TripStatus.active => scheme.onPrimaryContainer,\r\n      TripStatus.completed => scheme.onSecondaryContainer,\r\n      TripStatus.cancelled => scheme.onErrorContainer,\r\n    };\r\n\r\n    String text;\r\n    switch (status) {\r\n      case TripStatus.active:\r\n        text = 'Active';\r\n      case TripStatus.completed:\r\n        text = 'Completed';\r\n      case TripStatus.cancelled:\r\n        text = 'Cancelled';\r\n    }\r\n\r\n    return Container(\r\n      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),\r\n      decoration: BoxDecoration(\r\n        color: bg,\r\n        borderRadius: BorderRadius.circular(999),\r\n      ),\r\n      child: Text(\r\n        text,\r\n        style: Theme.of(context).textTheme.labelSmall?.copyWith(color: fg),\r\n      ),\r\n    );\r\n  }\r\n}\r\n\r\nclass _InfoRow extends StatelessWidget {\r\n  const _InfoRow({required this.icon, required this.label, required this.value});\r\n\r\n  final IconData icon;\r\n  final String label;\r\n  final String value;\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    final scheme = Theme.of(context).colorScheme;\r\n\r\n    return Row(\r\n      children: [\r\n        Icon(icon, size: 18, color: scheme.onSurfaceVariant),\r\n        const SizedBox(width: 8),\r\n        SizedBox(\r\n          width: 86,\r\n          child: Text(label, style: Theme.of(context).textTheme.bodySmall),\r\n        ),\r\n        Expanded(\r\n          child: Text(\r\n            value,\r\n            style: Theme.of(context).textTheme.bodyMedium,\r\n          ),\r\n        ),\r\n      ],\r\n    );\r\n  }\r\n}\r\n"
        }
    ]
}